<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard - Auth Debug</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
        }
        .debug-banner {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: bold;
        }
        .auth-status {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .auth-status.valid {
            border-left: 4px solid #27ae60;
        }
        .auth-status.invalid {
            border-left: 4px solid #e74c3c;
        }
        .api-tests {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .endpoint-test {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
        }
        .endpoint-test.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .endpoint-test.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .endpoint-test.pending {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .token-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            word-break: break-all;
        }
        .controls {
            margin: 20px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn.danger {
            background: #dc3545;
        }
        .btn.danger:hover {
            background: #c82333;
        }
    </style>
</head>
<body>
    <div class="debug-banner">
        üîß AUTHENTICATION DEBUG MODE - Dashboard API Testing
    </div>
    
    <div id="authStatus" class="auth-status">
        <h3>üîë Authentication Status</h3>
        <div id="authDetails">Checking authentication...</div>
        <div id="tokenInfo" class="token-info" style="display: none;"></div>
    </div>
    
    <div class="controls">
        <button class="btn" onclick="testAllEndpoints()">üß™ Test All Endpoints</button>
        <button class="btn" onclick="clearTokens()">üóëÔ∏è Clear Tokens</button>
        <button class="btn" onclick="goToLogin()">üîê Go to Login</button>
        <button class="btn danger" onclick="location.reload()">üîÑ Refresh Page</button>
    </div>
    
    <div class="api-tests">
        <h3>üìä Dashboard API Tests</h3>
        <div id="apiResults">Click "Test All Endpoints" to begin testing...</div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        
        // Dashboard endpoints to test
        const endpoints = [
            { url: '/api/dashboards/student/', name: 'Student Dashboard' },
            { url: '/api/users/student/profile/', name: 'Student Profile' },
            { url: '/api/internships/', name: 'Student Internships' },
            { url: '/api/application/my-applications/', name: 'Student Applications' },
            { url: '/api/dashboards/progress/', name: 'Progress Dashboard' },
            { url: '/api/internship-progress/progress/', name: 'Internship Progress' },
            { url: '/api/dashboards/analytics/', name: 'Analytics' },
            { url: '/api/dashboards/achievements/', name: 'Achievements' },
            { url: '/api/dashboards/calendar-events/', name: 'Calendar Events' }
        ];
        
        function checkAuthStatus() {
            const token = localStorage.getItem('access_token');
            const authStatus = document.getElementById('authStatus');
            const authDetails = document.getElementById('authDetails');
            const tokenInfo = document.getElementById('tokenInfo');
            
            if (token) {
                authStatus.className = 'auth-status valid';
                authDetails.innerHTML = `
                    <p>‚úÖ <strong>Authentication Token Found</strong></p>
                    <p>üìÖ Token stored in localStorage</p>
                    <p>üîç Token length: ${token.length} characters</p>
                `;
                
                // Show token info (first and last 20 chars for security)
                const tokenPreview = token.length > 40 ? 
                    `${token.substring(0, 20)}...${token.substring(token.length - 20)}` : 
                    token;
                
                tokenInfo.textContent = `Token: ${tokenPreview}`;
                tokenInfo.style.display = 'block';
                
                // Try to decode JWT payload (if it's a JWT)
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    const exp = new Date(payload.exp * 1000);
                    const now = new Date();
                    
                    if (exp > now) {
                        authDetails.innerHTML += `<p>‚è∞ Token expires: ${exp.toLocaleString()}</p>`;
                    } else {
                        authDetails.innerHTML += `<p>‚ö†Ô∏è Token expired: ${exp.toLocaleString()}</p>`;
                    }
                } catch (e) {
                    console.log('Token is not a valid JWT or cannot be decoded');
                }
                
            } else {
                authStatus.className = 'auth-status invalid';
                authDetails.innerHTML = `
                    <p>‚ùå <strong>No Authentication Token Found</strong></p>
                    <p>üîç Checked localStorage for 'access_token'</p>
                    <p>üí° You need to login first to test authenticated endpoints</p>
                `;
                tokenInfo.style.display = 'none';
            }
        }
        
        async function testEndpoint(endpoint) {
            const token = localStorage.getItem('access_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            try {
                console.log(`üß™ Testing: ${endpoint.url}`);
                
                const response = await fetch(`${API_BASE}${endpoint.url}`, {
                    method: 'GET',
                    headers: headers
                });
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    success: response.ok
                };
                
                // Try to get response text
                try {
                    const text = await response.text();
                    if (text) {
                        try {
                            result.data = JSON.parse(text);
                        } catch {
                            result.text = text.substring(0, 200) + (text.length > 200 ? '...' : '');
                        }
                    }
                } catch (e) {
                    result.error = 'Could not read response';
                }
                
                console.log(`üìä ${endpoint.name} result:`, result);
                return result;
                
            } catch (error) {
                console.error(`‚ùå ${endpoint.name} error:`, error);
                return {
                    status: 'ERROR',
                    error: error.message,
                    success: false
                };
            }
        }
        
        async function testAllEndpoints() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '<p>üîÑ Testing endpoints...</p>';
            
            const results = [];
            
            for (const endpoint of endpoints) {
                // Show pending status
                resultsDiv.innerHTML += `
                    <div class="endpoint-test pending" id="test-${endpoints.indexOf(endpoint)}">
                        üîÑ Testing ${endpoint.name} (${endpoint.url})...
                    </div>
                `;
                
                const result = await testEndpoint(endpoint);
                results.push({ endpoint, result });
                
                // Update result
                const testDiv = document.getElementById(`test-${endpoints.indexOf(endpoint)}`);
                const statusClass = result.success ? 'success' : 'error';
                const statusIcon = result.success ? '‚úÖ' : '‚ùå';
                
                let resultText = `${statusIcon} ${endpoint.name} - Status: ${result.status}`;
                
                if (!result.success) {
                    if (result.data && result.data.detail) {
                        resultText += ` - ${result.data.detail}`;
                    } else if (result.text) {
                        resultText += ` - ${result.text}`;
                    } else if (result.error) {
                        resultText += ` - ${result.error}`;
                    }
                }
                
                testDiv.className = `endpoint-test ${statusClass}`;
                testDiv.textContent = resultText;
                
                // Small delay between requests
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // Summary
            const successful = results.filter(r => r.result.success).length;
            const total = results.length;
            
            resultsDiv.innerHTML += `
                <div class="endpoint-test ${successful === total ? 'success' : 'error'}" style="margin-top: 20px; font-weight: bold;">
                    üìà Summary: ${successful}/${total} endpoints successful
                </div>
            `;
        }
        
        function clearTokens() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            alert('üóëÔ∏è Tokens cleared from localStorage');
            checkAuthStatus();
        }
        
        function goToLogin() {
            window.location.href = './login_orchestrator.html';
        }
        
        // Initialize on page load
        window.addEventListener('load', function() {
            console.log('üöÄ Student Dashboard Auth Debug loaded');
            checkAuthStatus();
        });
    </script>
</body>
</html>