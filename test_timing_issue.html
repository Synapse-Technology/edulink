<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Timing Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { margin: 5px 0; padding: 5px; background: #f0f0f0; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e9; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
    </style>
</head>
<body>
    <h1>Testing Authentication Timing</h1>
    <div id="logs"></div>
    
    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = `log ${type}`;
            logEntry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
            logsDiv.appendChild(logEntry);
            console.log(message);
        }
        
        // Simulate the immediate check (like in student_dash.html)
        log('Script loading - checking localStorage immediately', 'info');
        
        function isValidTokenFormat(token) {
            if (!token || typeof token !== 'string') return false;
            const parts = token.split('.');
            return parts.length === 3 && parts.every(part => part.length > 0);
        }
        
        const accessToken = localStorage.getItem('access_token');
        log(`Immediate check - Access token found: ${accessToken ? 'YES' : 'NO'}`, accessToken ? 'success' : 'error');
        
        if (accessToken) {
            log(`Token format valid: ${isValidTokenFormat(accessToken) ? 'YES' : 'NO'}`, isValidTokenFormat(accessToken) ? 'success' : 'error');
        }
        
        if (!accessToken || !isValidTokenFormat(accessToken)) {
            log('IMMEDIATE CHECK WOULD REDIRECT TO LOGIN!', 'error');
        } else {
            log('Immediate check passed', 'success');
        }
        
        // Simulate what happens when DOM loads
        document.addEventListener('DOMContentLoaded', function() {
            log('DOM loaded - checking localStorage again', 'info');
            
            const accessTokenDOM = localStorage.getItem('access_token');
            log(`DOM check - Access token found: ${accessTokenDOM ? 'YES' : 'NO'}`, accessTokenDOM ? 'success' : 'error');
            
            if (accessTokenDOM) {
                log(`Token format valid: ${isValidTokenFormat(accessTokenDOM) ? 'YES' : 'NO'}`, isValidTokenFormat(accessTokenDOM) ? 'success' : 'error');
            }
            
            if (!accessTokenDOM || !isValidTokenFormat(accessTokenDOM)) {
                log('DOM CHECK WOULD ALSO REDIRECT TO LOGIN!', 'error');
            } else {
                log('DOM check passed', 'success');
            }
        });
        
        // Add buttons to test setting tokens
        window.onload = function() {
            const buttonsDiv = document.createElement('div');
            buttonsDiv.innerHTML = `
                <h2>Test Actions</h2>
                <button onclick="setTestToken()">Set Test Token</button>
                <button onclick="clearToken()">Clear Token</button>
                <button onclick="checkToken()">Check Current Token</button>
                <button onclick="simulateLogin()">Simulate Login Process</button>
            `;
            document.body.appendChild(buttonsDiv);
        };
        
        function setTestToken() {
            const testToken = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzM4MDc0NTI4LCJpYXQiOjE3MzgwNzA5MjgsImp0aSI6IjEyMzQ1Njc4OTAiLCJ1c2VyX2lkIjoiY2UzYTFjZGYtN2FlYS00MTczLTk5OWMtNWVkYTQ1MWQ3Yzc2In0.test_signature';
            localStorage.setItem('access_token', testToken);
            log('Test token set', 'success');
            checkToken();
        }
        
        function clearToken() {
            localStorage.removeItem('access_token');
            log('Token cleared', 'info');
            checkToken();
        }
        
        function checkToken() {
            const token = localStorage.getItem('access_token');
            log(`Current token: ${token ? 'Present' : 'Not found'}`, token ? 'success' : 'error');
            if (token) {
                log(`Valid format: ${isValidTokenFormat(token) ? 'YES' : 'NO'}`, isValidTokenFormat(token) ? 'success' : 'error');
            }
        }
        
        async function simulateLogin() {
            log('Starting simulated login process...', 'info');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/auth/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email: 'obuyahcarol1@gmail.com', 
                        password: 'your_password_here' // You'll need to enter the actual password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('access_token', data.access);
                    localStorage.setItem('refresh_token', data.refresh);
                    localStorage.setItem('user', JSON.stringify(data.user));
                    
                    log('Login successful - tokens stored', 'success');
                    checkToken();
                    
                    // Test immediate redirect to dashboard
                    log('Testing redirect to dashboard...', 'info');
                    setTimeout(() => {
                        window.location.href = 'Edulink_website/dashboards/student/student_dash.html';
                    }, 2000);
                } else {
                    const error = await response.json();
                    log(`Login failed: ${JSON.stringify(error)}`, 'error');
                }
            } catch (error) {
                log(`Network error: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>