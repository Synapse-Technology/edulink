<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Management - EduLink KE</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <style>
        .student-filters {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        
        .student-card {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .student-card:hover {
            transform: translateY(-2px);
        }
        
        .student-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .student-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .student-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .student-details h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }
        
        .student-meta {
            color: #666;
            font-size: 0.9rem;
        }
        
        .student-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .student-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-item {
            text-align: center;
            padding: 0.75rem;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            display: block;
        }
        
        .stat-label {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.25rem;
        }
        
        .student-progress {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #e2e8f0;
        }
        
        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .progress-bar {
            width: 100px;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s ease;
        }
        
        .student-table {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .table-header {
            background: #f7fafc;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }
        
        .view-toggle button {
            padding: 0.5rem 1rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .view-toggle button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .export-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .export-btn:hover {
            background: #38a169;
        }
        
        @media (max-width: 768px) {
            .student-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .student-info {
                flex-direction: column;
                text-align: center;
            }
            
            .student-actions {
                justify-content: stretch;
            }
            
            .student-actions .btn {
                flex: 1;
                text-align: center;
            }
            
            .view-toggle {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <h1><i class="fas fa-users"></i> Student Management</h1>
            <div class="header-actions">
                <a href="dashboard.html" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
                <span id="welcomeMessage" class="welcome-message">Welcome</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- Summary Stats -->
        <div class="student-stats">
            <div class="stat-item">
                <span class="stat-value" id="totalStudents">0</span>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="activeStudents">0</span>
                <div class="stat-label">Active Students</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="placedStudents">0</span>
                <div class="stat-label">Placed Students</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="graduatedStudents">0</span>
                <div class="stat-label">Graduated</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="student-filters">
            <h3 style="margin-bottom: 1rem;">Filter Students</h3>
            <div class="filter-row">
                <div class="form-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" onchange="filterStudents()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="placed">Placed</option>
                        <option value="graduated">Graduated</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="courseFilter">Course</label>
                    <select id="courseFilter" onchange="filterStudents()">
                        <option value="">All Courses</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="yearFilter">Year</label>
                    <select id="yearFilter" onchange="filterStudents()">
                        <option value="">All Years</option>
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                        <option value="4">Year 4</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="searchFilter">Search</label>
                    <input type="text" id="searchFilter" placeholder="Student name, email..." oninput="filterStudents()">
                </div>
                
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="loadStudents()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- View Controls -->
        <div class="student-table">
            <div class="table-header">
                <h3>Students List</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="view-toggle">
                        <button id="cardViewBtn" class="active" onclick="switchView('card')">
                            <i class="fas fa-th-large"></i> Cards
                        </button>
                        <button id="tableViewBtn" onclick="switchView('table')">
                            <i class="fas fa-table"></i> Table
                        </button>
                    </div>
                    <button class="export-btn" onclick="exportStudents()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- Students List -->
            <div id="studentsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading students...</p>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="pagination" style="display: none;"></div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Student Details</h3>
                <button class="modal-close" onclick="closeStudentModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // Check authentication
        if (!checkAuthentication()) {
            return;
        }

        let currentStudents = [];
        let filteredStudents = [];
        let currentView = 'card';
        let currentPage = 1;
        const itemsPerPage = 12;

        // Load students on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();
            loadCourses();
        });

        // Load students from API
        async function loadStudents() {
            try {
                const data = await InstitutionAPIs.Students.getStudents();
                currentStudents = data.results || data || [];
                filteredStudents = [...currentStudents];
                updateStats();
                renderStudents();
            } catch (error) {
                document.getElementById('studentsList').innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-exclamation-triangle"></i> Failed to load students: ${error.message}
                    </div>
                `;
            }
        }

        // Load courses for filter
        async function loadCourses() {
            try {
                // This would typically come from an API
                const courses = [
                    'Computer Science',
                    'Information Technology',
                    'Software Engineering',
                    'Data Science',
                    'Cybersecurity'
                ];
                
                const courseFilter = document.getElementById('courseFilter');
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load courses:', error);
            }
        }

        // Update statistics
        function updateStats() {
            const total = currentStudents.length;
            const active = currentStudents.filter(s => s.status === 'active').length;
            const placed = currentStudents.filter(s => s.status === 'placed').length;
            const graduated = currentStudents.filter(s => s.status === 'graduated').length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('placedStudents').textContent = placed;
            document.getElementById('graduatedStudents').textContent = graduated;
        }

        // Filter students
        function filterStudents() {
            const statusFilter = document.getElementById('statusFilter').value;
            const courseFilter = document.getElementById('courseFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredStudents = currentStudents.filter(student => {
                // Status filter
                if (statusFilter && student.status !== statusFilter) return false;
                
                // Course filter
                if (courseFilter && student.course !== courseFilter) return false;
                
                // Year filter
                if (yearFilter && student.year_of_study !== parseInt(yearFilter)) return false;
                
                // Search filter
                if (searchFilter) {
                    const searchText = `${student.user?.first_name || ''} ${student.user?.last_name || ''} ${student.user?.email || ''} ${student.student_id || ''}`.toLowerCase();
                    if (!searchText.includes(searchFilter)) return false;
                }
                
                return true;
            });

            currentPage = 1;
            renderStudents();
        }

        // Switch view between card and table
        function switchView(view) {
            currentView = view;
            document.getElementById('cardViewBtn').classList.toggle('active', view === 'card');
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            renderStudents();
        }

        // Render students
        function renderStudents() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageStudents = filteredStudents.slice(startIndex, endIndex);

            if (pageStudents.length === 0) {
                document.getElementById('studentsList').innerHTML = `
                    <div class="alert alert-info" style="margin: 2rem;">
                        <i class="fas fa-info-circle"></i> No students found matching your criteria.
                    </div>
                `;
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            if (currentView === 'card') {
                renderCardView(pageStudents);
            } else {
                renderTableView(pageStudents);
            }

            renderPagination();
        }

        // Render card view
        function renderCardView(students) {
            const studentsHtml = students.map(student => {
                const initials = `${student.user?.first_name?.[0] || ''}${student.user?.last_name?.[0] || ''}`;
                const completionRate = Math.floor(Math.random() * 100); // Mock data
                
                return `
                    <div class="student-card">
                        <div class="student-header">
                            <div class="student-info">
                                <div class="student-avatar">${initials}</div>
                                <div class="student-details">
                                    <h3>${student.user?.first_name || ''} ${student.user?.last_name || ''}</h3>
                                    <div class="student-meta">
                                        <i class="fas fa-id-card"></i> ${student.student_id || 'N/A'}
                                        <span style="margin: 0 1rem;">•</span>
                                        <i class="fas fa-envelope"></i> ${student.user?.email || 'N/A'}
                                        <br>
                                        <i class="fas fa-graduation-cap"></i> ${student.course || 'N/A'}
                                        <span style="margin: 0 1rem;">•</span>
                                        <i class="fas fa-calendar"></i> Year ${student.year_of_study || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="student-actions">
                                <span class="status-badge status-${student.status || 'active'}">${student.status || 'active'}</span>
                                <button class="btn btn-primary" onclick="viewStudent(${student.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                        
                        <div class="student-progress">
                            <div class="progress-item">
                                <span>Course Progress</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${completionRate}%"></div>
                                </div>
                                <span>${completionRate}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('studentsList').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1rem; padding: 1rem;">
                    ${studentsHtml}
                </div>
            `;
        }

        // Render table view
        function renderTableView(students) {
            const studentsHtml = students.map(student => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="student-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                                ${student.user?.first_name?.[0] || ''}${student.user?.last_name?.[0] || ''}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${student.user?.first_name || ''} ${student.user?.last_name || ''}</div>
                                <div style="font-size: 0.8rem; color: #666;">${student.student_id || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${student.user?.email || 'N/A'}</td>
                    <td>${student.course || 'N/A'}</td>
                    <td>Year ${student.year_of_study || 'N/A'}</td>
                    <td><span class="status-badge status-${student.status || 'active'}">${student.status || 'active'}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewStudent(${student.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('studentsList').innerHTML = `
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Email</th>
                                <th>Course</th>
                                <th>Year</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentsHtml}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
            
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            let paginationHtml = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHtml += `
                        <button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHtml += '<span>...</span>';
                }
            }

            paginationHtml += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            document.getElementById('pagination').innerHTML = paginationHtml;
            document.getElementById('pagination').style.display = 'flex';
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderStudents();
            }
        }

        // View student details
        function viewStudent(studentId) {
            const student = currentStudents.find(s => s.id === studentId);
            if (!student) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="student-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div class="detail-item">
                        <span class="detail-label">Full Name</span>
                        <span class="detail-value">${student.user?.first_name || ''} ${student.user?.last_name || ''}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Student ID</span>
                        <span class="detail-value">${student.student_id || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">${student.user?.email || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Phone</span>
                        <span class="detail-value">${student.phone || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Course</span>
                        <span class="detail-value">${student.course || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Year of Study</span>
                        <span class="detail-value">Year ${student.year_of_study || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <span class="detail-value">
                            <span class="status-badge status-${student.status || 'active'}">${student.status || 'active'}</span>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date Joined</span>
                        <span class="detail-value">${student.date_joined ? new Date(student.date_joined).toLocaleDateString() : 'N/A'}</span>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h4>Academic Progress</h4>
                    <div class="progress-item">
                        <span>Overall Progress</span>
                        <div class="progress-bar" style="width: 200px;">
                            <div class="progress-fill" style="width: ${Math.floor(Math.random() * 100)}%"></div>
                        </div>
                        <span>${Math.floor(Math.random() * 100)}%</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="contactStudent(${studentId})">
                        <i class="fas fa-envelope"></i> Contact Student
                    </button>
                    <button class="btn btn-secondary" onclick="closeStudentModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;

            document.getElementById('studentModal').classList.add('show');
        }

        // Contact student
        function contactStudent(studentId) {
            const student = currentStudents.find(s => s.id === studentId);
            if (student && student.user?.email) {
                window.location.href = `mailto:${student.user.email}`;
            }
        }

        // Close student modal
        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('show');
        }

        // Export students
        function exportStudents() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Name,Student ID,Email,Course,Year,Status\n" +
                filteredStudents.map(student => 
                    `"${student.user?.first_name || ''} ${student.user?.last_name || ''}",` +
                    `"${student.student_id || ''}",` +
                    `"${student.user?.email || ''}",` +
                    `"${student.course || ''}",` +
                    `"${student.year_of_study || ''}",` +
                    `"${student.status || ''}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "students.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close modal when clicking outside
        document.getElementById('studentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeStudentModal();
            }
        });
    </script>
</body>
</html>