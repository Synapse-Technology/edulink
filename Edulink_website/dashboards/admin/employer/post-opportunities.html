<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; font-src 'self' https://fonts.gstatic.com https://cdnjs.cloudflare.com; img-src 'self' data: https:; connect-src 'self' https://edulink.jhubafrica.com https://edulink-api-n422.onrender.com https://edulink-api.onrender.com http://127.0.0.1:8000 http://localhost:8000; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self';">
  <title>EduLink - Post Opportunities</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js for enhanced analytics -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Date picker for scheduling -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <!-- Dashboard Backend Integration -->
  <!-- Dashboard Backend Integration - Modular Approach -->
  <script src="js/api-utils.js"></script>
  <script src="js/opportunities-backend.js"></script>
  <!-- Security Module -->
  <script src="js/employer-auth-security.js"></script>
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --secondary: #0ea5e9;
      --accent: #f59e0b;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --background: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --border: #e2e8f0;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --gradient-primary: linear-gradient(135deg, #2563eb 0%, #0ea5e9 100%);
      --gradient-secondary: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
    }
    
    [data-theme="dark"] {
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --secondary: #06b6d4;
      --accent: #fbbf24;
      --success: #34d399;
      --warning: #fbbf24;
      --danger: #f87171;
      --background: #0f172a;
      --card-bg: #1e293b;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --border: #334155;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
      --gradient-primary: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%);
      --gradient-secondary: linear-gradient(135deg, #fbbf24 0%, #f87171 100%);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', 'Poppins', sans-serif;
      background: var(--background);
      color: var(--text-primary);
      transition: all 0.3s ease;
    }
    
    .sidebar {
      background: var(--gradient-primary);
      box-shadow: var(--shadow-lg);
      border-right: 1px solid var(--border);
    }
    
    .sidebar-brand {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 1.75rem;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      letter-spacing: 0.5px;
    }
    
    .nav-item {
      transition: all 0.3s ease;
      border-radius: 12px;
      margin: 4px 8px;
    }
    
    .nav-item:hover {
      background: rgba(255,255,255,0.15);
      transform: translateX(4px);
    }
    
    .nav-item.active {
      background: rgba(255,255,255,0.2);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      transition: all 0.3s ease;
    }
    
    .card:hover {
      box-shadow: var(--shadow-lg);
      transform: translateY(-2px);
    }
    
    .btn-primary {
      background: var(--gradient-primary);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 24px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--shadow);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .dropdown-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .dropdown-content.show {
      max-height: 200px;
    }
    
    .dropdown-arrow {
      transition: transform 0.3s ease;
    }
    
    .dropdown-arrow.rotate {
      transform: rotate(180deg);
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Mobile Menu Button -->
  <button class="md:hidden fixed top-4 left-4 z-50 bg-white p-3 rounded-lg shadow-lg" onclick="toggleSidebar()" id="mobileMenuBtn">
    <i class="fas fa-bars text-gray-700"></i>
  </button>

  <!-- Sidebar -->
  <aside class="sidebar fixed left-0 top-0 h-full w-64 p-6 z-40 transform transition-transform duration-300 md:translate-x-0 -translate-x-full" id="sidebar">
    <div class="sidebar-brand text-center mb-8 pb-6 border-b border-white border-opacity-20">
      EduLink
      <div class="text-sm font-normal text-white text-opacity-80 mt-1">Employer Portal</div>
    </div>
    
    <nav class="space-y-1">
      <!-- Core Navigation -->
      <a href="dashboard.html" class="nav-item w-full text-left px-3 py-2 rounded-lg text-white flex items-center space-x-2 text-sm">
        <i class="fas fa-chart-line w-4"></i>
        <span>Dashboard</span>
      </a>
      <a href="post-opportunities.html" class="nav-item active w-full text-left px-3 py-2 rounded-lg text-white flex items-center space-x-2 text-sm bg-white bg-opacity-20">
        <i class="fas fa-plus-circle w-4"></i>
        <span>Post Opportunities</span>
      </a>
      <a href="notifications.html" class="nav-item w-full text-left px-3 py-2 rounded-lg text-white flex items-center space-x-2 text-sm hover:bg-white hover:bg-opacity-10">
        <i class="fas fa-bell w-4"></i>
        <span>Notifications</span>
      </a>
      
      <!-- Management Dropdown -->
      <div class="nav-dropdown">
        <button onclick="toggleDropdown('management')" class="nav-item w-full text-left px-3 py-2 rounded-lg text-white flex items-center justify-between text-sm hover:bg-white hover:bg-opacity-10">
          <div class="flex items-center space-x-2">
            <i class="fas fa-users w-4"></i>
            <span>Management</span>
          </div>
          <i class="fas fa-chevron-down w-3 dropdown-arrow transition-transform" id="management-arrow"></i>
        </button>
        <div id="management-dropdown" class="dropdown-content hidden ml-4 mt-1 space-y-1">
          <a href="applications.html" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-file-alt w-3"></i>
            <span>Applications</span>
          </a>
          <a href="interns.html" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-users w-3"></i>
            <span>Active Interns</span>
          </a>
          <a href="interviews.html" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-calendar-alt w-3"></i>
            <span>Interviews</span>
          </a>
          <button onclick="showSection('feedback')" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-comments w-3"></i>
            <span>Feedback</span>
          </a>
          <a href="supervisors.html" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-users-cog w-3"></i>
            <span>Supervisors</span>
          </a>
        </div>
      </div>
      
      <!-- Analytics Dropdown -->
      <div class="nav-dropdown">
        <button onclick="toggleDropdown('analytics')" class="nav-item w-full text-left px-3 py-2 rounded-lg text-white flex items-center justify-between text-sm hover:bg-white hover:bg-opacity-10">
          <div class="flex items-center space-x-2">
            <i class="fas fa-chart-bar w-4"></i>
            <span>Analytics</span>
          </div>
          <i class="fas fa-chevron-down w-3 dropdown-arrow transition-transform" id="analytics-arrow"></i>
        </button>
        <div id="analytics-dropdown" class="dropdown-content hidden ml-4 mt-1 space-y-1">
          <a href="analytics.html#performance" onclick="showSection('performance')" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-chart-line w-3"></i>
            <span>Performance</span>
          </a>
          <a href="analytics.html#reports" onclick="showSection('reports')" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-file-chart w-3"></i>
            <span>Reports</span>
          </a>
        </div>
      </div>
      
      <!-- System Dropdown -->
      <div class="nav-dropdown">
        <button onclick="toggleDropdown('system')" class="nav-item w-full text-left px-3 py-2 rounded-lg text-white flex items-center justify-between text-sm hover:bg-white hover:bg-opacity-10">
          <div class="flex items-center space-x-2">
            <i class="fas fa-cogs w-4"></i>
            <span>System</span>
          </div>
          <i class="fas fa-chevron-down w-3 dropdown-arrow transition-transform" id="system-arrow"></i>
        </button>
        <div id="system-dropdown" class="dropdown-content hidden ml-4 mt-1 space-y-1">
          <a href="system.html#integrations" onclick="showSection('integrations')" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-plug w-3"></i>
            <span>Integrations</span>
          </a>
          <a href="system.html#compliance" onclick="showSection('compliance')" class="nav-item w-full text-left px-3 py-1.5 rounded text-white flex items-center space-x-2 text-xs hover:bg-white hover:bg-opacity-10">
            <i class="fas fa-shield-alt w-3"></i>
            <span>Compliance</span>
          </a>
        </div>
      </div>
      
      <a href="opportunities.html" class="nav-item w-full text-left px-3 py-2 rounded-lg text-white flex items-center space-x-2 text-sm hover:bg-white hover:bg-opacity-10">
        <i class="fas fa-briefcase w-4"></i>
        <span>View Opportunities</span>
      </a>
    </nav>
    
    <div class="mt-auto pt-6 border-t border-white border-opacity-20">
      <a href="#" class="nav-item w-full text-left px-4 py-3 rounded-lg text-white flex items-center space-x-3 font-medium">
        <i class="fas fa-cog w-5"></i>
        <span>Settings</span>
      </a>
      <a href="#" class="nav-item w-full text-left px-4 py-3 rounded-lg text-white flex items-center space-x-3 font-medium">
        <i class="fas fa-question-circle w-5"></i>
        <span>Help Center</span>
      </a>
      <a href="#" class="nav-item w-full text-left px-4 py-3 rounded-lg text-white flex items-center space-x-3 font-medium">
        <i class="fas fa-sign-out-alt w-5"></i>
        <span>Log Out</span>
      </a>
    </div>
  </aside>

  <!-- Overlay for mobile -->
  <div class="fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden hidden" id="sidebarOverlay" onclick="toggleSidebar()"></div>

  <!-- Main Content -->
  <main class="md:ml-64 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 p-6">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">Post Opportunities</h1>
          <p class="text-gray-600 mt-1">Create and manage internship opportunities</p>
        </div>
        <div class="flex items-center space-x-4">
          <button class="p-2 text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fas fa-bell text-lg"></i>
          </button>
          <div class="flex items-center space-x-3">
            <img src="https://via.placeholder.com/40" alt="Profile" class="w-10 h-10 rounded-full">
            <div class="text-sm">
              <div class="font-medium text-gray-900">John Doe</div>
              <div class="text-gray-500">Employer</div>
            </div>
          </div>
        </div>
      </div>
    </header>

    <!-- Post Opportunities Section -->
    <div class="p-6">
      <div class="card p-8">
        <div class="flex items-center justify-between mb-8">
          <div>
            <h2 class="text-2xl font-bold text-gray-900 mb-2">Internship Opportunities</h2>
            <p class="text-gray-600">Manage your posted internship opportunities and create new ones</p>
          </div>
          <div class="flex items-center space-x-3">
            <button onclick="exportOpportunities()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-colors flex items-center space-x-2">
              <i class="fas fa-download"></i>
              <span>Export Data</span>
            </button>
            <button onclick="openPostInternshipModal()" class="btn-primary flex items-center space-x-2">
              <i class="fas fa-plus"></i>
              <span>Post New Opportunity</span>
            </button>
          </div>
        </div>

        <!-- Opportunities List -->
        <div class="space-y-4" id="opportunitiesList">
          <!-- Opportunities will be loaded here -->
        </div>
      </div>
    </div>
  </main>

  <!-- Post Internship Modal -->
  <div id="postInternshipModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <h3 class="text-xl font-bold text-gray-900">Post New Internship</h3>
          <button onclick="closePostInternshipModal()" class="text-gray-400 hover:text-gray-600">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
      </div>
      
      <form id="internshipForm" class="p-6 space-y-6">
        <input type="hidden" name="internshipId">
        
        <!-- Company Logo and Opportunity Image Section -->
        <div class="bg-gray-50 rounded-lg p-4 mb-6">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Visual Assets</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Company Logo</label>
              <div class="flex items-center space-x-4">
                <div id="companyLogoPreview" class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                  <i class="fas fa-building text-gray-400 text-xl"></i>
                </div>
                <div class="flex-1">
                  <p class="text-sm text-gray-600 mb-2">Logo will be loaded from company settings</p>
                  <button type="button" onclick="openLogoSettings()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                    <i class="fas fa-cog mr-1"></i>Manage Company Logo
                  </button>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Opportunity Image</label>
              <div class="flex items-center space-x-4">
                <div id="opportunityImagePreview" class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center border-2 border-dashed border-gray-300">
                  <i class="fas fa-image text-gray-400 text-xl"></i>
                </div>
                <div class="flex-1">
                  <input type="file" id="opportunityImage" accept="image/*" class="hidden" onchange="previewOpportunityImage(this)">
                  <button type="button" onclick="document.getElementById('opportunityImage').click()" class="bg-blue-50 text-blue-600 px-3 py-2 rounded-lg text-sm font-medium hover:bg-blue-100 transition-colors">
                    <i class="fas fa-upload mr-1"></i>Upload Image
                  </button>
                  <p class="text-xs text-gray-500 mt-1">JPG, PNG up to 2MB</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Basic Information -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Position Title</label>
            <input type="text" id="positionTitle" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="e.g., Software Development Intern" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
            <select id="department" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
              <option value="">Select Department</option>
              <option value="engineering">Engineering</option>
              <option value="marketing">Marketing</option>
              <option value="finance">Finance</option>
              <option value="hr">Human Resources</option>
              <option value="operations">Operations</option>
              <option value="design">Design</option>
              <option value="sales">Sales</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Duration (months)</label>
            <input type="number" id="duration" min="1" max="12" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="3" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Stipend (per month)</label>
            <input type="number" id="stipend" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="1000">
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
            <input type="date" id="startDate" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Application Deadline</label>
            <input type="date" id="applicationDeadline" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
          <textarea id="description" rows="4" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Describe the internship role, responsibilities, and what the intern will learn..." required></textarea>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Requirements</label>
          <textarea id="requirements" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="List the required skills, qualifications, and experience..." required></textarea>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Work Type</label>
            <select id="workType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
              <option value="">Select Work Type</option>
              <option value="remote">Remote</option>
              <option value="onsite">On-site</option>
              <option value="hybrid">Hybrid</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Number of Positions</label>
            <input type="number" id="positions" min="1" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="1" required>
          </div>
        </div>
        
        <!-- Visibility Controls -->
        <div class="bg-blue-50 rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Visibility & Access Control</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Visibility Type</label>
              <select id="visibilityType" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="toggleInstitutionSelect()" required>
                <option value="public">Public (Visible to all users)</option>
                <option value="restricted">Restricted (Institution-specific)</option>
              </select>
            </div>
            <div id="institutionSelectDiv" class="hidden">
              <label class="block text-sm font-medium text-gray-700 mb-2">Select Institutions</label>
              <select id="restrictedInstitutions" multiple class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                <option value="JKUAT">Jomo Kenyatta University of Agriculture and Technology (JKUAT)</option>
                <option value="UON">University of Nairobi</option>
                <option value="KU">Kenyatta University</option>
                <option value="MUST">Moi University</option>
                <option value="TUK">Technical University of Kenya</option>
                <option value="MMUST">Masinde Muliro University</option>
              </select>
              <p class="text-xs text-gray-500 mt-1">Hold Ctrl/Cmd to select multiple institutions</p>
            </div>
          </div>
        </div>
        
        <!-- Enhanced Application Process -->
        <div class="bg-green-50 rounded-lg p-4">
          <h4 class="text-lg font-semibold text-gray-900 mb-4">Application Requirements</h4>
          <div class="space-y-4">
            <div class="flex items-center space-x-3">
              <input type="checkbox" id="requireResume" checked disabled class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
              <label for="requireResume" class="text-sm font-medium text-gray-700">Resume/CV (Required by default)</label>
            </div>
            <div class="flex items-center space-x-3">
              <input type="checkbox" id="requireCoverLetter" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
              <label for="requireCoverLetter" class="text-sm font-medium text-gray-700">Cover Letter</label>
            </div>
            <div class="flex items-center space-x-3">
              <input type="checkbox" id="enableCustomQuestions" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" onchange="toggleCustomQuestions()">
              <label for="enableCustomQuestions" class="text-sm font-medium text-gray-700">Add Custom Application Questions</label>
            </div>
          </div>
          
          <!-- Custom Questions Section -->
          <div id="customQuestionsSection" class="hidden mt-4 space-y-3">
            <div class="border-t border-gray-200 pt-4">
              <div class="flex items-center justify-between mb-3">
                <h5 class="text-md font-medium text-gray-800">Custom Questions</h5>
                <button type="button" onclick="addCustomQuestion()" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                  <i class="fas fa-plus mr-1"></i>Add Question
                </button>
              </div>
              <div id="customQuestionsList" class="space-y-3">
                <!-- Custom questions will be added here dynamically -->
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex items-center justify-end space-x-4 pt-6 border-t border-gray-200">
          <button type="button" onclick="closePostInternshipModal()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors">
            Cancel
          </button>
          <button type="submit" class="btn-primary">
            Post Internship
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // Sidebar functionality
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      
      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('hidden');
    }

    // Dropdown functionality
    function toggleDropdown(dropdownId) {
      const dropdown = document.getElementById(dropdownId + '-dropdown');
      const arrow = document.getElementById(dropdownId + '-arrow');
      
      dropdown.classList.toggle('hidden');
      dropdown.classList.toggle('show');
      arrow.classList.toggle('rotate');
    }

    // Modal functionality
    function openPostInternshipModal() {
      document.getElementById('postInternshipModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      populateAudienceDropdown();
    }

    function closePostInternshipModal() {
      document.getElementById('postInternshipModal').classList.add('hidden');
      document.body.style.overflow = 'auto';
      document.getElementById('internshipForm').reset();
    }

    // Populate audience dropdown from localStorage
    function populateAudienceDropdown() {
      const select = document.getElementById('audienceSelect');
      if (!select) return;
      // Remove all except 'Everyone'
      for (let i = select.options.length - 1; i > 0; i--) select.remove(i);
      const institutions = JSON.parse(localStorage.getItem('institutions') || '[]');
      institutions.forEach(inst => {
        const opt = document.createElement('option');
        opt.value = inst;
        opt.textContent = inst;
        select.appendChild(opt);
      });
    }

    // Initialize security module
    const security = new EmployerAuthSecurity();
    
    // Initialize opportunities backend
    let opportunitiesBackend;
    
    // Initialize backend on page load
    async function initializeBackend() {
      try {
        opportunitiesBackend = new OpportunitiesBackend();
        await opportunitiesBackend.initialize();
        console.log('Opportunities backend initialized successfully');
      } catch (error) {
        console.warn('Failed to initialize opportunities backend:', error);
        opportunitiesBackend = null;
      }
    }
    
    // New functionality for enhanced features
    function openLogoSettings() {
      alert('This would open company logo management settings. In a real implementation, this would navigate to a settings page where employers can upload and manage their company logo.');
    }
    
    function previewOpportunityImage(input) {
      const preview = document.getElementById('opportunityImagePreview');
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
          preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover rounded-lg" alt="Opportunity preview">`;
        };
        reader.readAsDataURL(input.files[0]);
      }
    }
    
    function toggleInstitutionSelect() {
      const visibilityType = document.getElementById('visibilityType').value;
      const institutionDiv = document.getElementById('institutionSelectDiv');
      
      if (visibilityType === 'restricted') {
        institutionDiv.classList.remove('hidden');
      } else {
        institutionDiv.classList.add('hidden');
      }
    }
    
    function toggleCustomQuestions() {
      const checkbox = document.getElementById('enableCustomQuestions');
      const section = document.getElementById('customQuestionsSection');
      
      if (checkbox.checked) {
        section.classList.remove('hidden');
      } else {
        section.classList.add('hidden');
      }
    }
    
    let questionCounter = 0;
    function addCustomQuestion() {
      questionCounter++;
      const questionsList = document.getElementById('customQuestionsList');
      const questionDiv = document.createElement('div');
      questionDiv.className = 'bg-white p-3 rounded-lg border border-gray-200';
      questionDiv.innerHTML = `
        <div class="flex items-start space-x-3">
          <div class="flex-1">
            <input type="text" placeholder="Enter your question..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" name="customQuestion${questionCounter}">
            <div class="mt-2">
              <select class="px-3 py-1 border border-gray-300 rounded text-sm" name="questionType${questionCounter}">
                <option value="text">Text Answer</option>
                <option value="textarea">Long Text</option>
                <option value="multiple">Multiple Choice</option>
              </select>
            </div>
          </div>
          <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-red-600 hover:text-red-800 text-sm">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `;
      questionsList.appendChild(questionDiv);
    }
    
    // Form submission
    document.getElementById('internshipForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Check rate limiting for form submissions
      const rateLimitResult = security.rateLimitFormSubmission();
      if (!security.showRateLimitMessage(rateLimitResult)) {
        return;
      }
      
      let internships = JSON.parse(localStorage.getItem('internships') || '[]');
      const form = document.getElementById('internshipForm');
      const idx = form.querySelector('input[name="internshipId"]').value;
      
      // Collect form data
      const formData = {
        title: document.getElementById('positionTitle').value,
        department: document.getElementById('department').value,
        duration: document.getElementById('duration').value,
        stipend: document.getElementById('stipend').value || '0',
        deadline: document.getElementById('applicationDeadline').value,
        description: document.getElementById('description').value,
        requirements: document.getElementById('requirements').value,
        workType: document.getElementById('workType').value,
        positions: document.getElementById('positions').value
      };
      
      // Validate required fields
      const requiredFields = ['title', 'department', 'duration', 'deadline', 'description', 'requirements', 'workType', 'positions'];
      let missing = [];
      requiredFields.forEach(field => {
        if (!formData[field] || formData[field].trim() === '') {
          missing.push(field);
        }
      });
      
      if (missing.length > 0) {
        alert('Please fill all required fields: ' + missing.join(', '));
        return;
      }
      
      // Enhanced validation and sanitization
      const validation = security.validateFormData(formData);
      if (!validation.valid) {
        alert('Validation errors:\n' + validation.errors.join('\n'));
        return;
      }
      
      // Check for potential security threats
      for (const [key, value] of Object.entries(formData)) {
        if (security.containsSQLInjection(value)) {
          alert('Invalid input detected. Please remove any special characters or scripts.');
          return;
        }
      }
      
      // Validate positions is a positive number
      const positions = parseInt(formData.positions);
      if (isNaN(positions) || positions <= 0 || positions > 100) {
        alert('Number of positions must be between 1 and 100');
        return;
      }
      
      // Validate deadline is in the future
      const deadlineDate = new Date(formData.deadline);
      const today = new Date();
      if (deadlineDate <= today) {
        alert('Application deadline must be in the future');
        return;
      }
      
      // Collect enhanced form data
      const visibilityType = document.getElementById('visibilityType').value;
      const restrictedInstitutions = visibilityType === 'restricted' ? 
        Array.from(document.getElementById('restrictedInstitutions').selectedOptions).map(option => option.value) : [];
      
      const requireCoverLetter = document.getElementById('requireCoverLetter').checked;
      const enableCustomQuestions = document.getElementById('enableCustomQuestions').checked;
      
      // Collect custom questions
      const customQuestions = [];
      if (enableCustomQuestions) {
        const questionInputs = document.querySelectorAll('[name^="customQuestion"]');
        questionInputs.forEach((input, index) => {
          if (input.value.trim()) {
            const questionNumber = input.name.replace('customQuestion', '');
            const typeSelect = document.querySelector(`[name="questionType${questionNumber}"]`);
            customQuestions.push({
              question: input.value.trim(),
              type: typeSelect ? typeSelect.value : 'text',
              required: true
            });
          }
        });
      }
      
      // Handle opportunity image
      const opportunityImageFile = document.getElementById('opportunityImage').files[0];
      let opportunityImageData = null;
      if (opportunityImageFile) {
        // In a real implementation, this would be uploaded to a server
        // For now, we'll store a placeholder reference
        opportunityImageData = {
          name: opportunityImageFile.name,
          size: opportunityImageFile.size,
          type: opportunityImageFile.type,
          lastModified: opportunityImageFile.lastModified
        };
      }
      
      const data = {
        ...validation.data,
        status: 'active',
        location: 'To be determined',
        visibilityType: visibilityType,
        restrictedInstitutions: restrictedInstitutions,
        applicationRequirements: {
          resume: true, // Always required
          coverLetter: requireCoverLetter,
          customQuestions: customQuestions
        },
        opportunityImage: opportunityImageFile, // Pass the actual file for backend
        companyLogo: 'from_settings' // Reference to company settings
      };
      
      try {
        if (opportunitiesBackend) {
          if (idx !== '') {
            // Update existing opportunity
            await opportunitiesBackend.updateOpportunity(internships[idx].id, data);
          } else {
            // Create new opportunity
            await opportunitiesBackend.createOpportunity(data);
          }
          
          // Show success message and close modal
          alert('Internship posted successfully!');
          closePostInternshipModal();
          
          // Reload opportunities list
          await loadOpportunities();
        } else {
          // Fallback to local storage
          const opportunityImageData = opportunityImageFile ? {
            name: opportunityImageFile.name,
            size: opportunityImageFile.size,
            type: opportunityImageFile.type,
            lastModified: opportunityImageFile.lastModified
          } : null;
          
          const localData = {
            ...data,
            opportunityImage: opportunityImageData,
            id: idx !== '' ? internships[idx].id : Date.now()
          };
          
          if (idx !== '') {
            internships[idx] = localData;
          } else {
            internships.push(localData);
          }
          
          localStorage.setItem('internships', JSON.stringify(internships));
          
          // Show success message and close modal
          alert('Internship posted successfully!');
          closePostInternshipModal();
          
          // Reload opportunities list
          loadOpportunities();
        }
      } catch (error) {
        console.error('Failed to save opportunity:', error);
        alert('Failed to save opportunity. Please try again.');
      }
    });

    // Load opportunities from backend or localStorage
    async function loadOpportunities() {
      const opportunitiesList = document.getElementById('opportunitiesList');
      let internships = [];
      let applications = {};
      
      try {
        if (opportunitiesBackend) {
          // Load from backend
          const response = await opportunitiesBackend.loadOpportunities();
          internships = response.results || [];
          
          // Load applications count for each opportunity
          for (let opp of internships) {
            try {
              const appResponse = await opportunitiesBackend.getOpportunityApplications(opp.id);
              applications[opp.id] = appResponse.results || [];
            } catch (error) {
              console.warn(`Failed to load applications for opportunity ${opp.id}:`, error);
              applications[opp.id] = [];
            }
          }
        } else {
          // Fallback to localStorage
          internships = JSON.parse(localStorage.getItem('internships') || '[]');
          applications = JSON.parse(localStorage.getItem('applications') || '{}');
        }
      } catch (error) {
        console.error('Failed to load opportunities:', error);
        // Fallback to localStorage
        internships = JSON.parse(localStorage.getItem('internships') || '[]');
        applications = JSON.parse(localStorage.getItem('applications') || '{}');
      }
      
      if (!internships.length) {
        opportunitiesList.innerHTML = '<div class="text-center text-gray-500 py-8">No opportunities posted yet. Click "Post New Opportunity" to get started.</div>';
        return;
      }
      
      opportunitiesList.innerHTML = internships.map((opp, idx) => {
        const applicationCount = opportunitiesBackend ? 
          (applications[opp.id] || []).length : 
          (applications[opp.title] || []).length;
        
        return `
          <div class="bg-gray-50 rounded-lg p-6 border border-gray-200">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <h3 class="text-lg font-semibold text-gray-900">${opp.title}</h3>
                <div class="flex items-center space-x-4 mt-2 text-sm text-gray-600">
                  <span><i class="fas fa-building mr-1"></i>${opp.department}</span>
                  <span><i class="fas fa-clock mr-1"></i>${opp.duration} months</span>
                  <span><i class="fas fa-dollar-sign mr-1"></i>$${opp.stipend}</span>
                  <span><i class="fas fa-users mr-1"></i>${applicationCount} applications</span>
                  <span><i class="fas fa-calendar mr-1"></i>Deadline: ${opp.application_deadline || opp.deadline}</span>
                </div>
              </div>
              <div class="flex items-center space-x-3">
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">${opp.status}</span>
                <button onclick="editInternship(${opportunitiesBackend ? opp.id : idx})" class="text-blue-600 hover:text-blue-800 font-medium">Edit</button>
                <button onclick="deleteInternship(${opportunitiesBackend ? opp.id : idx})" class="text-red-600 hover:text-red-800 font-medium">Delete</button>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Edit internship function
    async function editInternship(idOrIdx) {
      let internships = [];
      let intern = null;
      
      try {
        if (opportunitiesBackend) {
          // Load from backend
          const response = await opportunitiesBackend.loadOpportunities();
          internships = response.results || [];
          intern = internships.find(opp => opp.id === idOrIdx);
        } else {
          // Fallback to localStorage
          internships = JSON.parse(localStorage.getItem('internships') || '[]');
          intern = internships[idOrIdx];
        }
      } catch (error) {
        console.error('Failed to load opportunity for editing:', error);
        // Fallback to localStorage
        internships = JSON.parse(localStorage.getItem('internships') || '[]');
        intern = internships[idOrIdx];
      }
      
      if (!intern) {
        alert('Opportunity not found');
        return;
      }
      
      const form = document.getElementById('internshipForm');
      
      document.getElementById('postInternshipModal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      populateAudienceDropdown();
      
      // Populate form with existing data
      form.querySelector('input[name="internshipId"]').value = opportunitiesBackend ? intern.id : idOrIdx;
      document.getElementById('positionTitle').value = intern.title;
      document.getElementById('department').value = intern.department;
      document.getElementById('duration').value = intern.duration;
      document.getElementById('stipend').value = intern.stipend;
      document.getElementById('applicationDeadline').value = intern.application_deadline || intern.deadline;
      document.getElementById('description').value = intern.description;
      document.getElementById('requirements').value = intern.requirements;
      document.getElementById('workType').value = intern.workType || intern.work_type;
      document.getElementById('positions').value = intern.positions || 1;
      
      // Set start date if available
      if (intern.start_date) {
        document.getElementById('startDate').value = intern.start_date;
      }
    }

    // Delete internship function
    async function deleteInternship(idOrIdx) {
      if (confirm('Are you sure you want to delete this opportunity?')) {
        try {
          if (opportunitiesBackend) {
            // Delete from backend
            await opportunitiesBackend.deleteOpportunity(idOrIdx);
            await loadOpportunities();
          } else {
            // Fallback to localStorage
            let internships = JSON.parse(localStorage.getItem('internships') || '[]');
            internships.splice(idOrIdx, 1);
            localStorage.setItem('internships', JSON.stringify(internships));
            loadOpportunities();
          }
        } catch (error) {
          console.error('Failed to delete opportunity:', error);
          alert('Failed to delete opportunity. Please try again.');
        }
      }
    }

    // Initialize page
    document.addEventListener('DOMContentLoaded', async function() {
      await initializeBackend();
      await loadOpportunities();
    });
    
    // Add export functionality
    async function exportOpportunities() {
      try {
        if (opportunitiesBackend) {
          await opportunitiesBackend.exportOpportunities('csv');
        } else {
          // Fallback: create CSV from localStorage data
          const internships = JSON.parse(localStorage.getItem('internships') || '[]');
          const csvContent = 'data:text/csv;charset=utf-8,' + 
            'Title,Department,Duration,Stipend,Deadline,Status\n' +
            internships.map(opp => 
              `"${opp.title}","${opp.department}","${opp.duration}","${opp.stipend}","${opp.deadline || opp.application_deadline}","${opp.status}"`
            ).join('\n');
          
          const encodedUri = encodeURI(csvContent);
          const link = document.createElement('a');
          link.setAttribute('href', encodedUri);
          link.setAttribute('download', `opportunities_${new Date().toISOString().split('T')[0]}.csv`);
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
      } catch (error) {
        console.error('Failed to export opportunities:', error);
        alert('Failed to export opportunities. Please try again.');
      }
    }
  </script>
</body>
</html>