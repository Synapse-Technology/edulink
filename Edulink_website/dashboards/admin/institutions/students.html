<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Students - Institution Dashboard - EduLink</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

</head>
<body>
    <!-- Top Header Bar -->
    <div class="top-header">
        <div class="header-left" style="padding-left: 30px;">
            <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">EduLink</div>
        </div>
        <div class="header-center">
            <div class="welcome-text" id="institutionWelcome">Student Management</div>
        </div>
        <div class="header-right" style="padding-right: 30px;">
            <div class="notification-icon" onclick="openNotificationsModal()">
                <i class="fas fa-bell"></i>
            </div>
            <div class="profile-pic">
                <img src="https://via.placeholder.com/40" alt="Profile">
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="dashboard.html" class="nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="departments.html" class="nav-link">
                        <i class="fas fa-building"></i>
                        <span>Departments</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="internships.html" class="nav-link">
                        <i class="fas fa-briefcase"></i>
                        <span>Internships</span>
                    </a>
                </li>
                <li class="nav-item active">
                    <a href="#" class="nav-link" data-section="students">
                        <i class="fas fa-users"></i>
                        <span>Students</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="applications.html" class="nav-link">
                        <i class="fas fa-file-alt"></i>
                        <span>Applications</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="supervisors.html" class="nav-link">
                        <i class="fas fa-user-tie"></i>
                        <span>Supervisors</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reports.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
            
            <!-- Logout Button -->
            <div class="sidebar-logout">
                <a href="#" class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="closeSidebar()"></div>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Students Section -->
            <section id="students" class="content-section active">
                <!-- Enhanced Student Management Header -->
                <div class="student-management-hero">
                    <div class="hero-background">
                        <div class="hero-pattern"></div>
                        <div class="hero-gradient"></div>
                    </div>
                    <div class="hero-content">
                        <div class="hero-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="hero-text">
                            <h1 class="hero-title">Student Management</h1>
                            <p class="hero-subtitle">Comprehensive platform to manage and monitor student information, academic progress, and activities</p>
                            <div class="hero-features">
                                <span class="feature-tag"><i class="fas fa-chart-line"></i> Progress Tracking</span>
                                <span class="feature-tag"><i class="fas fa-users-cog"></i> Student Management</span>
                                <span class="feature-tag"><i class="fas fa-analytics"></i> Performance Analytics</span>
                            </div>
                        </div>
                    </div>
                    <div class="hero-actions">
                        <button class="hero-btn primary">
                            <i class="fas fa-plus"></i>
                            Add Student
                        </button>
                        <button class="hero-btn secondary">
                            <i class="fas fa-file-import"></i>
                            Import Data
                        </button>
                    </div>
                </div>
        <!-- Summary Stats -->
        <div class="student-stats">
            <div class="stat-item">
                <span class="stat-value" id="totalStudents">0</span>
                <div class="stat-label">Total Students</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="activeStudents">0</span>
                <div class="stat-label">Active Students</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="placedStudents">0</span>
                <div class="stat-label">Placed Students</div>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="graduatedStudents">0</span>
                <div class="stat-label">Graduated</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="student-filters">
            <h3 style="margin-bottom: 1rem;">Filter Students</h3>
            <div class="filter-row">
                <div class="form-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter" onchange="filterStudents()">
                        <option value="">All Statuses</option>
                        <option value="active">Active</option>
                        <option value="placed">Placed</option>
                        <option value="graduated">Graduated</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="courseFilter">Course</label>
                    <select id="courseFilter" onchange="filterStudents()">
                        <option value="">All Courses</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="yearFilter">Year</label>
                    <select id="yearFilter" onchange="filterStudents()">
                        <option value="">All Years</option>
                        <option value="1">Year 1</option>
                        <option value="2">Year 2</option>
                        <option value="3">Year 3</option>
                        <option value="4">Year 4</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="searchFilter">Search</label>
                    <input type="text" id="searchFilter" placeholder="Student name, email..." oninput="filterStudents()">
                </div>
                
                <div class="form-group">
                    <label>&nbsp;</label>
                    <button class="btn btn-primary" onclick="loadStudents()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- View Controls -->
        <div class="student-table">
            <div class="table-header">
                <h3>Students List</h3>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <div class="view-toggle">
                        <button id="cardViewBtn" class="active" onclick="switchView('card')">
                            <i class="fas fa-th-large"></i> Cards
                        </button>
                        <button id="tableViewBtn" onclick="switchView('table')">
                            <i class="fas fa-table"></i> Table
                        </button>
                    </div>
                    <button class="export-btn" onclick="exportStudents()">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            </div>

            <!-- Students List -->
            <div id="studentsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading students...</p>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="pagination" style="display: none;"></div>
    </div>

    <!-- Student Detail Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Student Details</h3>
                <button class="modal-close" onclick="closeStudentModal()">&times;</button>
            </div>
            <div id="modalBody">
                <!-- Modal content will be populated dynamically -->
            </div>
        </div>
    </div>

    <script src="api.js"></script>
    <script>
        // Check authentication
        if (!checkAuthentication()) {
            window.location.href = '../../../authentication/login.html';
        }

        let currentStudents = [];
        let filteredStudents = [];
        let currentView = 'card';
        let currentPage = 1;
        const itemsPerPage = 12;

        // Load students on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadStudents();
            loadCourses();
        });

        // Load students from API
        async function loadStudents() {
            try {
                // Check if APIs are available
                if (typeof InstitutionAPIs === 'undefined' || !InstitutionAPIs.Students) {
                    console.error('Students API not available');
                    showErrorMessage('Students API is not available. Please refresh the page.');
                    return;
                }
                
                const data = await InstitutionAPIs.Students.getStudents();
                currentStudents = data.results || data || [];
                filteredStudents = [...currentStudents];
                updateStats();
                renderStudents();
            } catch (error) {
                console.error('Error loading students:', error);
                showErrorMessage('Failed to load students. Please try refreshing the page.');
            }
        }
        
        // Demo students function removed - platform now only displays real user data

        // Load courses for filter
        async function loadCourses() {
            try {
                // This would typically come from an API
                const courses = [
                    'Computer Science',
                    'Information Technology',
                    'Software Engineering',
                    'Data Science',
                    'Cybersecurity'
                ];
                
                const courseFilter = document.getElementById('courseFilter');
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    courseFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load courses:', error);
            }
        }

        // Update statistics
        function updateStats() {
            const total = currentStudents.length;
            const active = currentStudents.filter(s => s.status === 'active').length;
            const placed = currentStudents.filter(s => s.status === 'placed').length;
            const graduated = currentStudents.filter(s => s.status === 'graduated').length;

            document.getElementById('totalStudents').textContent = total;
            document.getElementById('activeStudents').textContent = active;
            document.getElementById('placedStudents').textContent = placed;
            document.getElementById('graduatedStudents').textContent = graduated;
        }

        // Filter students
        function filterStudents() {
            const statusFilter = document.getElementById('statusFilter').value;
            const courseFilter = document.getElementById('courseFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();

            filteredStudents = currentStudents.filter(student => {
                // Status filter
                if (statusFilter && student.status !== statusFilter) return false;
                
                // Course filter
                if (courseFilter && student.course !== courseFilter) return false;
                
                // Year filter
                if (yearFilter && student.year_of_study !== parseInt(yearFilter)) return false;
                
                // Search filter
                if (searchFilter) {
                    const searchText = `${student.user?.first_name || ''} ${student.user?.last_name || ''} ${student.user?.email || ''} ${student.student_id || ''}`.toLowerCase();
                    if (!searchText.includes(searchFilter)) return false;
                }
                
                return true;
            });

            currentPage = 1;
            renderStudents();
        }

        // Switch view between card and table
        function switchView(view) {
            currentView = view;
            document.getElementById('cardViewBtn').classList.toggle('active', view === 'card');
            document.getElementById('tableViewBtn').classList.toggle('active', view === 'table');
            renderStudents();
        }

        // Render students
        function renderStudents() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageStudents = filteredStudents.slice(startIndex, endIndex);

            if (pageStudents.length === 0) {
                document.getElementById('studentsList').innerHTML = `
                    <div class="alert alert-info" style="margin: 2rem;">
                        <i class="fas fa-info-circle"></i> No students found matching your criteria.
                    </div>
                `;
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            if (currentView === 'card') {
                renderCardView(pageStudents);
            } else {
                renderTableView(pageStudents);
            }

            renderPagination();
        }

        // Render card view
        function renderCardView(students) {
            const studentsHtml = students.map(student => {
                const initials = `${student.user?.first_name?.[0] || ''}${student.user?.last_name?.[0] || ''}`;
                const completionRate = Math.floor(Math.random() * 100); // Mock data
                
                return `
                    <div class="student-card">
                        <div class="student-header">
                            <div class="student-info">
                                <div class="student-avatar">${initials}</div>
                                <div class="student-details">
                                    <h3>${student.user?.first_name || ''} ${student.user?.last_name || ''}</h3>
                                    <div class="student-meta">
                                        <i class="fas fa-id-card"></i> ${student.student_id || 'N/A'}
                                        <span style="margin: 0 1rem;">•</span>
                                        <i class="fas fa-envelope"></i> ${student.user?.email || 'N/A'}
                                        <br>
                                        <i class="fas fa-graduation-cap"></i> ${student.course || 'N/A'}
                                        <span style="margin: 0 1rem;">•</span>
                                        <i class="fas fa-calendar"></i> Year ${student.year_of_study || 'N/A'}
                                    </div>
                                </div>
                            </div>
                            <div class="student-actions">
                                <span class="status-badge status-${student.status || 'active'}">${student.status || 'active'}</span>
                                <button class="btn btn-primary" onclick="viewStudent(${student.id})">
                                    <i class="fas fa-eye"></i> View
                                </button>
                            </div>
                        </div>
                        
                        <div class="student-progress">
                            <div class="progress-item">
                                <span>Course Progress</span>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${completionRate}%"></div>
                                </div>
                                <span>${completionRate}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('studentsList').innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1rem; padding: 1rem;">
                    ${studentsHtml}
                </div>
            `;
        }

        // Render table view
        function renderTableView(students) {
            const studentsHtml = students.map(student => `
                <tr>
                    <td>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <div class="student-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                                ${student.user?.first_name?.[0] || ''}${student.user?.last_name?.[0] || ''}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${student.user?.first_name || ''} ${student.user?.last_name || ''}</div>
                                <div style="font-size: 0.8rem; color: #666;">${student.student_id || 'N/A'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${student.user?.email || 'N/A'}</td>
                    <td>${student.course || 'N/A'}</td>
                    <td>Year ${student.year_of_study || 'N/A'}</td>
                    <td><span class="status-badge status-${student.status || 'active'}">${student.status || 'active'}</span></td>
                    <td>
                        <button class="btn btn-primary btn-sm" onclick="viewStudent(${student.id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                    </td>
                </tr>
            `).join('');

            document.getElementById('studentsList').innerHTML = `
                <div style="overflow-x: auto;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Student</th>
                                <th>Email</th>
                                <th>Course</th>
                                <th>Year</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentsHtml}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Render pagination
        function renderPagination() {
            const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
            
            if (totalPages <= 1) {
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            let paginationHtml = `
                <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    paginationHtml += `
                        <button onclick="changePage(${i})" ${i === currentPage ? 'class="active"' : ''}>
                            ${i}
                        </button>
                    `;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    paginationHtml += '<span>...</span>';
                }
            }

            paginationHtml += `
                <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;

            document.getElementById('pagination').innerHTML = paginationHtml;
            document.getElementById('pagination').style.display = 'flex';
        }

        // Change page
        function changePage(page) {
            const totalPages = Math.ceil(filteredStudents.length / itemsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                renderStudents();
            }
        }

        // View student details
        function viewStudent(studentId) {
            const student = currentStudents.find(s => s.id === studentId);
            if (!student) return;

            const modalBody = document.getElementById('modalBody');
            modalBody.innerHTML = `
                <div class="student-details" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                    <div class="detail-item">
                        <span class="detail-label">Full Name</span>
                        <span class="detail-value">${student.user?.first_name || ''} ${student.user?.last_name || ''}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Student ID</span>
                        <span class="detail-value">${student.student_id || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">${student.user?.email || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Phone</span>
                        <span class="detail-value">${student.phone || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Course</span>
                        <span class="detail-value">${student.course || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Year of Study</span>
                        <span class="detail-value">Year ${student.year_of_study || 'N/A'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Status</span>
                        <span class="detail-value">
                            <span class="status-badge status-${student.status || 'active'}">${student.status || 'active'}</span>
                        </span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Date Joined</span>
                        <span class="detail-value">${student.date_joined ? new Date(student.date_joined).toLocaleDateString() : 'N/A'}</span>
                    </div>
                </div>
                
                <div style="margin-top: 2rem;">
                    <h4>Academic Progress</h4>
                    <div class="progress-item">
                        <span>Overall Progress</span>
                        <div class="progress-bar" style="width: 200px;">
                            <div class="progress-fill" style="width: ${Math.floor(Math.random() * 100)}%"></div>
                        </div>
                        <span>${Math.floor(Math.random() * 100)}%</span>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="contactStudent(${studentId})">
                        <i class="fas fa-envelope"></i> Contact Student
                    </button>
                    <button class="btn btn-secondary" onclick="closeStudentModal()">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;

            document.getElementById('studentModal').classList.add('show');
        }

        // Contact student
        function contactStudent(studentId) {
            const student = currentStudents.find(s => s.id === studentId);
            if (student && student.user?.email) {
                window.location.href = `mailto:${student.user.email}`;
            }
        }

        // Close student modal
        function closeStudentModal() {
            document.getElementById('studentModal').classList.remove('show');
        }

        // Export students
        function exportStudents() {
            const csvContent = "data:text/csv;charset=utf-8," + 
                "Name,Student ID,Email,Course,Year,Status\n" +
                filteredStudents.map(student => 
                    `"${student.user?.first_name || ''} ${student.user?.last_name || ''}",` +
                    `"${student.student_id || ''}",` +
                    `"${student.user?.email || ''}",` +
                    `"${student.course || ''}",` +
                    `"${student.year_of_study || ''}",` +
                    `"${student.status || ''}"`
                ).join("\n");

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "students.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close modal when clicking outside
        document.getElementById('studentModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeStudentModal();
            }
        });
        
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            body.classList.toggle('sidebar-open');
        }
        
        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            body.classList.remove('sidebar-open');
        }
        
        // Close sidebar when clicking on main content on mobile
        document.querySelector('.main-content').addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });
        
        // Logout functionality
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any stored authentication data
                localStorage.removeItem('authToken');
                sessionStorage.removeItem('authToken');
                
                // Redirect to login page
                window.location.href = '../../../login.html';
            }
        }
    </script>
            </section>
        </main>
    </div>
</body>
</html>