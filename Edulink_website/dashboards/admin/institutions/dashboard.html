<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0, minimum-scale=1.0">
    <meta name="csrf-token" content="">
    <title>Institution Dashboard - EduLink</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="fontawesome-fallback.css">
    <script src="chart.min.js"></script>
</head>
<body>
    <!-- Top Header Bar -->
    <div class="top-header">
        <div class="header-left" style="padding-left: 30px;">
            <button class="mobile-menu-toggle" onclick="toggleSidebar()" aria-label="Toggle navigation">
                <i class="fas fa-bars"></i>
            </button>
            <div class="logo">EduLink</div>
        </div>
        <div class="header-center">
            <div class="welcome-text" id="institutionWelcome">Institution Dashboard</div>
        </div>
        <div class="header-right" style="padding-right: 30px;">
            <div class="notification-icon" onclick="openNotificationsModal()">
                <i class="fas fa-bell"></i>
            </div>
            <div class="profile-pic">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='40' height='40' viewBox='0 0 40 40'%3E%3Ccircle cx='20' cy='20' r='20' fill='%23e0e0e0'/%3E%3Ccircle cx='20' cy='15' r='6' fill='%23999'/%3E%3Cpath d='M8 32c0-6.627 5.373-12 12-12s12 5.373 12 12' fill='%23999'/%3E%3C/svg%3E" alt="Profile">
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <ul class="nav-menu">
                <li class="nav-item active">
                    <a href="#" class="nav-link" data-section="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="departments.html" class="nav-link">
                        <i class="fas fa-building"></i>
                        <span>Departments</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="internships.html" class="nav-link">
                        <i class="fas fa-briefcase"></i>
                        <span>Internships</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="students.html" class="nav-link">
                        <i class="fas fa-users"></i>
                        <span>Students</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="applications.html" class="nav-link">
                        <i class="fas fa-file-alt"></i>
                        <span>Applications</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="supervisors.html" class="nav-link">
                        <i class="fas fa-user-tie"></i>
                        <span>Supervisors</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="reports.html" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="settings.html" class="nav-link">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
            
            <!-- Logout Button -->
            <div class="sidebar-logout">
                <a href="#" class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </nav>

        <!-- Mobile Overlay -->
        <div class="mobile-overlay" onclick="closeSidebar()"></div>
        
        <!-- Main Content Area -->
        <main class="main-content">
            <!-- Dashboard Overview Section -->
            <section id="dashboard" class="content-section active">
                <!-- Welcome Section -->
                <div class="welcome-section">
                    <div class="welcome-content">
                        <h1 class="dashboard-title">Dashboard Overview</h1>
                        <p id="institutionDescription" class="welcome-message">Welcome back! Here's what's happening with your institution.</p>
                    </div>
                </div>
                
                <!-- Action Bar -->
                <div class="action-bar">
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="openGenerateCodeModal()" title="Generate Registration Code">
                            <i class="fas fa-key"></i> Generate Code
                        </button>
                        <button class="btn btn-secondary" onclick="refreshDashboardData()" title="Refresh Data">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Summary Cards -->
                <div class="summary-cards">
                    <div class="card">
                        <div class="card-icon" style="color: #33D999;">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="card-content">
                            <h3>Active Students</h3>
                            <div class="card-value" id="activeInternships">0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-icon" style="color: #1a5f7a;">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="card-content">
                            <h3>Total Students</h3>
                            <div class="card-value" id="verifiedStudents">0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-icon" style="color: #ff6b6b;">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="card-content">
                            <h3>Accepted Applications</h3>
                            <div class="card-value" id="certificatesIssued">0</div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-icon" style="color: #4ecdc4;">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="card-content">
                            <h3>Active Placements</h3>
                            <div class="card-value" id="avgCompletionTime">0</div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="charts-section">
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-line"></i> Application Trends</h3>
                        <canvas id="applicationsChart" width="400" height="200"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3><i class="fas fa-chart-pie"></i> Application Status Distribution</h3>
                        <canvas id="departmentChart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="recent-activity">
                    <h3>Recent Activity</h3>
                    <div class="activity-list" id="activityList">
                        <!-- Activity items will be populated by JavaScript -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notifications Modal -->
    <div id="notificationsModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <span class="close" onclick="closeNotificationsModal()">&times;</span>
            <h2><i class="fas fa-bell"></i> Notifications</h2>
            <div class="notifications-tabs">
                <button class="notifications-tab-btn active" data-tab="inbox">Inbox</button>
                <button class="notifications-tab-btn" data-tab="sent">Sent</button>
            </div>
            <div id="notificationsTabContent">
                <div class="notifications-tab-panel" data-tab-panel="inbox" style="display:block;">
                    <div id="notificationsInboxList"></div>
                </div>
                <div class="notifications-tab-panel" data-tab-panel="sent" style="display:none;">
                    <div id="notificationsSentList"></div>
                </div>
            </div>
            <div style="margin-top:24px; text-align:right;">
                <button class="btn btn-primary" id="composeNotificationBtn"><i class="fas fa-paper-plane"></i> Compose Notification</button>
            </div>
        </div>
    </div>

    <!-- Generate Registration Code Modal -->
    <div id="generateCodeModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close" onclick="closeGenerateCodeModal()">&times;</span>
            <h2><i class="fas fa-key"></i> Generate Registration Code</h2>
            <p>Generate a new registration code for students to register with your institution.</p>
            
            <form id="generateCodeForm">
                <div class="form-group">
                    <label for="maxUses">Maximum Uses:</label>
                    <input type="number" id="maxUses" name="maxUses" value="50" min="1" max="1000" required>
                    <small>Number of students who can use this code</small>
                </div>
                
                <div class="form-group">
                    <label for="expiresDays">Expires in (days):</label>
                    <input type="number" id="expiresDays" name="expiresDays" value="365" min="1" max="3650" required>
                    <small>How many days until the code expires</small>
                </div>
                
                <div style="margin-top: 24px; text-align: right;">
                    <button type="button" class="btn btn-secondary" onclick="closeGenerateCodeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="generateCodeBtn">
                        <i class="fas fa-key"></i> Generate Code
                    </button>
                </div>
            </form>
            
            <!-- Generated Code Display -->
            <div id="generatedCodeDisplay" style="display: none; margin-top: 24px; padding: 20px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #28a745;">
                <h3><i class="fas fa-check-circle" style="color: #28a745;"></i> Code Generated Successfully!</h3>
                <div style="margin: 16px 0;">
                    <label style="font-weight: 600; display: block; margin-bottom: 8px;">Registration Code:</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="text" id="generatedCode" readonly style="flex: 1; font-family: monospace; font-size: 18px; font-weight: bold; background: white; border: 2px solid #28a745;">
                        <button type="button" class="btn btn-secondary" onclick="copyCodeToClipboard()" title="Copy to clipboard">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>
                <div class="code-details" id="codeDetails">
                    <!-- Code details will be populated here -->
                </div>
                <div style="margin-top: 16px; padding: 12px; background: #e3f2fd; border-radius: 4px;">
                    <p style="margin: 0; font-size: 14px; color: #1976d2;">
                        <i class="fas fa-info-circle"></i> 
                        Share this code with students who want to register with your institution. 
                        They can use it during the registration process.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dashboard initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Check if APIs are available
            if (typeof InstitutionAPIs === 'undefined') {
                console.warn('InstitutionAPIs not loaded, running in demo mode');
                initializeCharts();
                setupEventListeners();
                loadDemoData();
                return;
            }
            
            // Check authentication
            if (!InstitutionAPIs.Auth.isAuthenticated()) {
                console.warn('User not authenticated, redirecting to login');
                // window.location.href = 'login.html';
                // For demo purposes, continue loading
                initializeCharts();
                setupEventListeners();
                loadDemoData();
                return;
            }

            const user = InstitutionAPIs.Auth.getCurrentUser();
            if (!user || user.role !== 'institution_admin') {
                console.warn('User role not authorized, redirecting to login');
                // window.location.href = 'login.html';
                // For demo purposes, continue loading
                initializeCharts();
                setupEventListeners();
                loadDemoData();
                return;
            }

            // Load institution profile and dashboard data
            loadInstitutionProfile();
            loadDashboardData();
            initializeCharts();
            loadRecentActivity();
            setupEventListeners();
        });
        
        // Sidebar toggle functionality
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            const mainContent = document.querySelector('.main-content');
            
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
            body.classList.toggle('sidebar-open');
            
            // Ensure main content can still scroll when sidebar is open
            if (body.classList.contains('sidebar-open')) {
                if (mainContent) {
                    mainContent.style.overflowY = 'auto';
                    mainContent.style.height = 'calc(100vh - 80px)';
                }
            }
        }
        
        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            body.classList.remove('sidebar-open');
        }
        
        // Close sidebar when clicking on main content on mobile
        document.querySelector('.main-content').addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                closeSidebar();
            }
        });
        
        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                closeSidebar();
            }
        });
        
        // Logout functionality
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                // Clear any stored authentication data
                localStorage.removeItem('authToken');
                sessionStorage.removeItem('authToken');
                
                // Redirect to login page
                window.location.href = '../../../login.html';
            }
        }

        // Load institution profile for personalization
        async function loadInstitutionProfile() {
            try {
                if (typeof InstitutionAPIs === 'undefined' || !InstitutionAPIs.Institution) {
                    console.warn('Institution APIs not available');
                    return;
                }
                
                const profile = await InstitutionAPIs.Institution.getProfile();
                
                // Update header with institution name
                const welcomeElement = document.getElementById('institutionWelcome');
                if (welcomeElement && profile.institution_name) {
                    welcomeElement.textContent = `${profile.institution_name} Dashboard`;
                }
                
                // Update description with personalized message
                const descriptionElement = document.getElementById('institutionDescription');
                if (descriptionElement && profile.institution_name) {
                    descriptionElement.textContent = `Welcome back! Here's what's happening at ${profile.institution_name}.`;
                }
                
                // Store institution info for later use
                window.currentInstitution = {
                    name: profile.institution_name,
                    type: profile.institution_type,
                    registrationNumber: profile.registration_number
                };
                
            } catch (error) {
                console.error('Error loading institution profile:', error);
                // Fallback to generic messages if profile loading fails
            }
        }

        // Load dashboard statistics
        async function loadDashboardData() {
            try {
                if (typeof InstitutionAPIs === 'undefined' || !InstitutionAPIs.Dashboard) {
                    console.warn('Dashboard APIs not available, loading demo data');
                    loadDemoData();
                    return;
                }
                
                const stats = await InstitutionAPIs.Dashboard.getStats();
                
                // Update summary cards with real data
                document.getElementById('activeInternships').textContent = stats.active_students || '0';
                document.getElementById('verifiedStudents').textContent = stats.total_students || '0';
                document.getElementById('certificatesIssued').textContent = stats.application_status?.accepted || '0';
                document.getElementById('avgCompletionTime').textContent = stats.application_status?.accepted || '0';
                
                // Update chart data with real statistics
                updateChartsWithRealData(stats);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showErrorMessage('Failed to load dashboard statistics');
                loadDemoData(); // Fallback to demo data
            }
        }

        // Initialize charts with default data
        let applicationsChart, departmentChart;
        
        function initializeCharts() {
            // Check if Chart.js is loaded
            if (typeof Chart === 'undefined') {
                console.warn('Chart.js not loaded, skipping chart initialization');
                return;
            }
            
            // Applications Chart
            const applicationsCtx = document.getElementById('applicationsChart');
            if (!applicationsCtx) {
                console.warn('Applications chart canvas not found');
                return;
            }
            
            applicationsChart = new Chart(applicationsCtx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Applications',
                        data: [0, 0, 0, 0, 0, 0],
                        borderColor: '#33D999',
                        backgroundColor: 'rgba(51, 217, 153, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Department Chart
            const departmentCtx = document.getElementById('departmentChart');
            if (!departmentCtx) {
                console.warn('Department chart canvas not found');
                return;
            }
            
            departmentChart = new Chart(departmentCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['Pending', 'Reviewed', 'Accepted', 'Rejected'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#ffc107', '#17a2b8', '#28a745', '#dc3545']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Update charts with real data
        function updateChartsWithRealData(stats) {
            // Update application status chart
            if (departmentChart && stats.application_status) {
                const statusData = [
                    stats.application_status.pending || 0,
                    stats.application_status.reviewed || 0,
                    stats.application_status.accepted || 0,
                    stats.application_status.rejected || 0
                ];
                departmentChart.data.datasets[0].data = statusData;
                departmentChart.update();
            }
            
            // For applications chart, we'll use mock data for now
            // In a real implementation, you'd get monthly application data from the backend
            if (applicationsChart && stats.total_applications) {
                const monthlyData = generateMonthlyData(stats.total_applications);
                applicationsChart.data.datasets[0].data = monthlyData;
                applicationsChart.update();
            }
        }
        
        // Generate mock monthly data based on total applications
        function generateMonthlyData(total) {
            const months = 6;
            const baseValue = Math.floor(total / months);
            return Array.from({length: months}, () => 
                Math.max(0, baseValue + Math.floor(Math.random() * 10) - 5)
            );
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                if (typeof InstitutionAPIs === 'undefined' || !InstitutionAPIs.Dashboard) {
                    console.warn('Dashboard APIs not available, loading demo activity');
                    loadDemoActivity();
                    return;
                }
                
                const activityData = await InstitutionAPIs.Dashboard.getRecentActivity();
                const activities = activityData.activities || [];
                
                const activityList = document.getElementById('activityList');
                
                if (activities.length === 0) {
                    activityList.innerHTML = `
                        <div class="activity-item">
                            <div class="activity-icon info">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <div class="activity-content">
                                <p>No recent activity</p>
                                <span class="activity-time">Check back later</span>
                            </div>
                        </div>
             `;
             
             // Add some test content to ensure there's enough content to scroll
             activityList.innerHTML += `
                 <div class="activity-item">
                     <div class="activity-icon info">
                         <i class="fas fa-info-circle"></i>
                     </div>
                     <div class="activity-content">
                         <p>Test scrolling content</p>
                         <span class="activity-description">This is additional content to test scrolling functionality</span>
                         <span class="activity-time">Test item</span>
                     </div>
                 </div>
             `.repeat(10);
                    return;
                }
                
                activityList.innerHTML = activities.map(activity => {
                    const icon = getActivityIcon(activity.type);
                    const timeAgo = formatTimeAgo(activity.timestamp);
                    
                    return `
                        <div class="activity-item">
                            <div class="activity-icon ${getActivityTypeClass(activity.status)}">
                                <i class="${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <p>${activity.title}</p>
                                <span class="activity-description">${activity.description}</span>
                                <span class="activity-time">${timeAgo}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading recent activity:', error);
                loadDemoActivity(); // Fallback to demo activity
            }
        }
        
        // Helper functions for activity display
        function getActivityIcon(type) {
            const icons = {
                'application': 'fas fa-file-alt',
                'student': 'fas fa-user-plus',
                'internship': 'fas fa-briefcase',
                'default': 'fas fa-bell'
            };
            return icons[type] || icons.default;
        }
        
        function getActivityTypeClass(status) {
            const classes = {
                'pending': 'info',
                'accepted': 'success',
                'rejected': 'error',
                'reviewed': 'warning',
                'default': 'info'
            };
            return classes[status] || classes.default;
        }
        
        function formatTimeAgo(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
            return `${Math.floor(diffInSeconds / 86400)} days ago`;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Navigation links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.getAttribute('href') !== '#') {
                        return; // Allow normal navigation for external links
                    }
                    e.preventDefault();
                    
                    // Update active state
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    this.closest('.nav-item').classList.add('active');
                });
            });
        }

        // Notifications functions
        function openNotificationsModal() {
            document.getElementById('notificationsModal').style.display = 'block';
            loadNotifications();
        }

        function closeNotificationsModal() {
            document.getElementById('notificationsModal').style.display = 'none';
        }

        function loadNotifications() {
            // For now, show no notifications - this can be enhanced later
            const inboxList = document.getElementById('notificationsInboxList');
            inboxList.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #666;">
                    <i class="fas fa-bell-slash" style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;"></i>
                    <p>No new notifications</p>
                </div>
            `;
        }
        
        // Refresh dashboard data
        async function refreshDashboardData() {
            const refreshBtn = document.querySelector('button[onclick="refreshDashboardData()"]');
            const icon = refreshBtn.querySelector('i');
            
            // Show loading state
            icon.classList.add('fa-spin');
            refreshBtn.disabled = true;
            
            try {
                // Clear cache and reload data if APIs are available
                if (typeof InstitutionAPIs !== 'undefined' && InstitutionAPIs.Cache) {
                    InstitutionAPIs.Cache.clear('dashboard_stats');
                    InstitutionAPIs.Cache.clear('recent_activity');
                }
                
                // Reload all data
                await Promise.all([
                    loadDashboardData(),
                    loadRecentActivity()
                ]);
                
                showSuccessMessage('Dashboard data refreshed successfully!');
            } catch (error) {
                console.error('Error refreshing dashboard:', error);
                showErrorMessage('Failed to refresh dashboard data');
            } finally {
                // Reset button state
                icon.classList.remove('fa-spin');
                refreshBtn.disabled = false;
            }
        }
        
        // Success message display
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'alert alert-success';
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 15px;
                border-radius: 5px;
                z-index: 1000;
                max-width: 300px;
            `;
            successDiv.innerHTML = `
                <i class="fas fa-check-circle"></i>
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; font-size: 18px; cursor: pointer;">&times;</button>
            `;
            document.body.appendChild(successDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (successDiv.parentElement) {
                    successDiv.remove();
                }
            }, 3000);
        }

        // Error message display
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'alert alert-error';
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #dc3545;
                color: white;
                padding: 15px;
                border-radius: 5px;
                z-index: 1000;
                max-width: 300px;
            `;
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
                <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: white; font-size: 18px; cursor: pointer;">&times;</button>
            `;
            document.body.appendChild(errorDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
                    <!-- Recent activity will be dynamically generated -->
    <!-- Toast Container -->
    <div class="toast-container toast-container--top-right"></div>

    <!-- Scripts -->
    <script src="api.js"></script>
    <script>
        // Dashboard functionality
        class InstitutionDashboard {
            constructor() {
                this.init();
            }

            async init() {
                // Check authentication
                if (!InstitutionAPIs.Auth.isAuthenticated()) {
                    window.location.href = 'login.html';
                    return;
                }

                const user = InstitutionAPIs.Auth.getCurrentUser();
                if (!user || user.role !== 'institution_admin') {
                    window.location.href = 'login.html';
                    return;
                }

                await this.loadDashboardData();
                this.setupEventListeners();
            }

            async loadDashboardData() {
                try {
                    // Load stats
                    await this.loadStats();
                    // Load recent activity
                    await this.loadRecentActivity();
                } catch (error) {
                    console.error('Error loading dashboard data:', error);
                    this.showError('Failed to load dashboard data');
                }
            }

            async loadStats() {
                try {
                    const stats = await InstitutionAPIs.Dashboard.getStats();
                    this.renderStats(stats);
                } catch (error) {
                    console.error('Error loading stats:', error);
                    // Load demo data as fallback
                    this.loadDemoStats();
                }
            }

            loadDemoStats() {
                const demoStats = {
                    total_students: 156,
                    total_applications: 89,
                    approved_applications: 67,
                    pending_applications: 22
                };
                this.renderStats(demoStats);
                this.showDemoNotice();
            }

            async loadRecentActivity() {
                try {
                    const activity = await InstitutionAPIs.Dashboard.getRecentActivity();
                    this.renderRecentActivity(activity);
                } catch (error) {
                    console.error('Error loading recent activity:', error);
                    // Load demo data as fallback
                    this.loadDemoActivity();
                }
            }

            loadDemoActivity() {
                const demoActivity = [
                    {
                        type: 'application',
                        title: 'New Application Received',
                        description: 'John Smith submitted internship application',
                        created_at: new Date().toISOString()
                    },
                    {
                        type: 'approval',
                        title: 'Application Approved',
                        description: 'Sarah Johnson\'s application was approved',
                        created_at: new Date(Date.now() - 3600000).toISOString()
                    },
                    {
                        type: 'student',
                        title: 'Student Registered',
                        description: 'Mike Davis joined the program',
                        created_at: new Date(Date.now() - 7200000).toISOString()
                    }
                ];
                this.renderRecentActivity(demoActivity);
            }

            renderStats(stats) {
                const statsContainer = document.querySelector('[data-dashboard="stats"]');
                if (!statsContainer) return;

                statsContainer.innerHTML = `
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">👥</div>
                            <div>
                                <h3>Total Students</h3>
                                <div class="card-value">${stats.total_students || 0}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">📄</div>
                            <div>
                                <h3>Applications</h3>
                                <div class="card-value">${stats.total_applications || 0}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">✅</div>
                            <div>
                                <h3>Approved</h3>
                                <div class="card-value">${stats.approved_applications || 0}</div>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header">
                            <div class="card-icon">⏳</div>
                            <div>
                                <h3>Pending</h3>
                                <div class="card-value">${stats.pending_applications || 0}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderRecentActivity(activities) {
                const activityContainer = document.querySelector('[data-dashboard="activity"]');
                if (!activityContainer) return;

                if (!activities || activities.length === 0) {
                    activityContainer.innerHTML = '<p class="loading">No recent activity</p>';
                    return;
                }

                const activityHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">${this.getActivityIcon(activity.type)}</div>
                        <div class="activity-content">
                            <p class="activity-title">${activity.title}</p>
                            <p class="activity-description">${activity.description}</p>
                            <span class="activity-time">${this.formatDate(activity.created_at)}</span>
                        </div>
                    </div>
                `).join('');

                activityContainer.innerHTML = `
                    <div class="activity-list">
                        ${activityHTML}
                    </div>
                `;
            }

            getActivityIcon(type) {
                const icons = {
                    'application': '📄',
                    'student': '👤',
                    'approval': '✅',
                    'rejection': '❌',
                    'default': '📋'
                };
                return icons[type] || icons.default;
            }

            formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
            }

            setupEventListeners() {
                // Refresh button
                document.querySelector('[data-action="refresh"]')?.addEventListener('click', () => {
                    this.loadDashboardData();
                });

                // Refresh activity button
                document.querySelector('[data-action="refresh-activity"]')?.addEventListener('click', () => {
                    this.loadRecentActivity();
                });
            }

            showError(message) {
                const errorHTML = `<div class="error">${message}</div>`;
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.insertAdjacentHTML('afterbegin', errorHTML);
                } else {
                    console.error('Main content element not found for error display:', message);
                }
            }
        }

        // Registration Code Generation Functions
        function openGenerateCodeModal() {
            document.getElementById('generateCodeModal').style.display = 'block';
            // Reset form and hide generated code display
            document.getElementById('generateCodeForm').reset();
            document.getElementById('generatedCodeDisplay').style.display = 'none';
        }

        function closeGenerateCodeModal() {
            document.getElementById('generateCodeModal').style.display = 'none';
        }

        function copyCodeToClipboard() {
            const codeInput = document.getElementById('generatedCode');
            codeInput.select();
            codeInput.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                // Show temporary feedback
                const copyBtn = event.target.closest('button');
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check"></i>';
                copyBtn.style.background = '#28a745';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.style.background = '';
                }, 2000);
            } catch (err) {
                console.error('Failed to copy code:', err);
                alert('Failed to copy code. Please copy manually.');
            }
        }

        // Handle generate code form submission
        document.addEventListener('DOMContentLoaded', function() {
            const generateCodeForm = document.getElementById('generateCodeForm');
            if (generateCodeForm) {
                generateCodeForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const generateBtn = document.getElementById('generateCodeBtn');
                    const originalBtnText = generateBtn.innerHTML;
                    
                    try {
                        // Show loading state
                        generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
                        generateBtn.disabled = true;
                        
                        const formData = new FormData(generateCodeForm);
                        const data = {
                            max_uses: parseInt(formData.get('maxUses')),
                            expires_days: parseInt(formData.get('expiresDays'))
                        };
                        
                        const response = await fetch((window.API_CONFIG?.BASE_URL || 'http://127.0.0.1:8000') + '/api/institutions/generate-code/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('authToken')}`,
                                'X-CSRFToken': document.querySelector('[name=csrf-token]')?.getAttribute('content') || ''
                            },
                            body: JSON.stringify(data)
                        });
                        
                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            // Show generated code
                            document.getElementById('generatedCode').value = result.code.code;
                            
                            // Populate code details
                            const codeDetails = document.getElementById('codeDetails');
                            codeDetails.innerHTML = `
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
                                    <div>
                                        <strong>Institution:</strong><br>
                                        <span>${result.code.institution}</span>
                                    </div>
                                    <div>
                                        <strong>Maximum Uses:</strong><br>
                                        <span>${result.code.max_uses}</span>
                                    </div>
                                    <div>
                                        <strong>Current Uses:</strong><br>
                                        <span>${result.code.current_uses}</span>
                                    </div>
                                    <div>
                                        <strong>Expires:</strong><br>
                                        <span>${new Date(result.code.expires_at).toLocaleDateString()}</span>
                                    </div>
                                </div>
                            `;
                            
                            // Hide form and show generated code
                            generateCodeForm.style.display = 'none';
                            document.getElementById('generatedCodeDisplay').style.display = 'block';
                            
                            // Show success message
                            showSuccessMessage('Registration code generated successfully!');
                            
                        } else {
                            throw new Error(result.message || 'Failed to generate registration code');
                        }
                        
                    } catch (error) {
                        console.error('Error generating code:', error);
                        showErrorMessage('Failed to generate registration code: ' + error.message);
                    } finally {
                        // Reset button state
                        generateBtn.innerHTML = originalBtnText;
                        generateBtn.disabled = false;
                    }
                });
            }
        });

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const generateCodeModal = document.getElementById('generateCodeModal');
            if (event.target === generateCodeModal) {
                closeGenerateCodeModal();
            }
        });

        // Demo data loading functions
        function loadDemoData() {
            // Load demo statistics
            document.getElementById('activeInternships').textContent = '24';
            document.getElementById('verifiedStudents').textContent = '156';
            document.getElementById('certificatesIssued').textContent = '18';
            document.getElementById('avgCompletionTime').textContent = '12';
            
            // Update charts with demo data
            const demoStats = {
                application_status: {
                    pending: 8,
                    reviewed: 12,
                    accepted: 18,
                    rejected: 5
                },
                total_applications: 43
            };
            updateChartsWithRealData(demoStats);
        }
        
        function loadDemoActivity() {
            const activityList = document.getElementById('activityList');
            activityList.innerHTML = `
                <div class="activity-item">
                    <div class="activity-icon success">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <div class="activity-content">
                        <p>New student registration</p>
                        <span class="activity-description">John Doe registered for Computer Science program</span>
                        <span class="activity-time">2 hours ago</span>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon info">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <div class="activity-content">
                        <p>Application submitted</p>
                        <span class="activity-description">Sarah Smith submitted internship application</span>
                        <span class="activity-time">4 hours ago</span>
                    </div>
                </div>
                <div class="activity-item">
                    <div class="activity-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="activity-content">
                        <p>Application approved</p>
                        <span class="activity-description">Mike Johnson's application was approved</span>
                        <span class="activity-time">1 day ago</span>
                    </div>
                </div>
            `;
        }

        // Legacy logout function for compatibility
        function logout() {
            if (typeof InstitutionAPIs !== 'undefined' && InstitutionAPIs.Auth) {
                InstitutionAPIs.Auth.logout();
            }
            window.location.href = 'login.html';
        }

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new InstitutionDashboard();
            
            // Ensure scrolling is always enabled
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.overflowY = 'auto';
                mainContent.style.height = 'calc(100vh - 80px)';
                console.log('Main content scrolling enabled');
            }
        });
    </script>
    
    <style>
        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-bottom: 1px solid #eee;
            transition: background-color 0.2s;
        }
        
        .activity-item:hover {
            background-color: #f8f9fa;
        }
        
        .activity-icon {
            font-size: 1.5rem;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .activity-description {
            color: #666;
            margin-bottom: 0.5rem;
        }
        
        .activity-time {
            font-size: 0.875rem;
            color: #999;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
    </style>
</body>
</html>