<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Monitoring Dashboard - Edulink</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.css" rel="stylesheet">
    <link href="{% static 'monitoring/css/dashboard.css' %}" rel="stylesheet">
    <style>
        .dashboard-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease-in-out;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
        }
        .status-healthy { color: #28a745; }
        .status-warning { color: #ffc107; }
        .status-critical { color: #dc3545; }
        .status-unknown { color: #6c757d; }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .alert-item {
            border-left: 4px solid;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 0 8px 8px 0;
        }
        .alert-critical { border-left-color: #dc3545; background-color: #f8d7da; }
        .alert-warning { border-left-color: #ffc107; background-color: #fff3cd; }
        .alert-info { border-left-color: #17a2b8; background-color: #d1ecf1; }
        .chart-container {
            position: relative;
            height: 300px;
        }
        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1050;
        }
        .loading-spinner {
            display: none;
        }
        @media (max-width: 768px) {
            .metric-value { font-size: 1.5rem; }
            .chart-container { height: 250px; }
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-chart-line me-2"></i>
                Edulink Monitoring Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text me-3">
                    <i class="fas fa-clock me-1"></i>
                    Last Updated: <span id="lastUpdated">--</span>
                </span>
                <button class="btn btn-outline-light btn-sm" onclick="refreshDashboard()">
                    <i class="fas fa-sync-alt" id="refreshIcon"></i>
                    Refresh
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- System Status Overview -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-heartbeat me-2"></i>
                            System Health Overview
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 col-6 mb-3">
                                <div class="metric-value" id="overallStatus">--</div>
                                <div class="metric-label">Overall Status</div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="metric-value" id="cpuUsage">--</div>
                                <div class="metric-label">CPU Usage</div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="metric-value" id="memoryUsage">--</div>
                                <div class="metric-label">Memory Usage</div>
                            </div>
                            <div class="col-md-3 col-6 mb-3">
                                <div class="metric-value" id="diskUsage">--</div>
                                <div class="metric-label">Disk Usage</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Metrics -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card dashboard-card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>
                            System Performance Trends
                        </h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <input type="radio" class="btn-check" name="timeRange" id="range1h" value="1" checked>
                            <label class="btn btn-outline-primary" for="range1h">1H</label>
                            <input type="radio" class="btn-check" name="timeRange" id="range6h" value="6">
                            <label class="btn btn-outline-primary" for="range6h">6H</label>
                            <input type="radio" class="btn-check" name="timeRange" id="range24h" value="24">
                            <label class="btn btn-outline-primary" for="range24h">24H</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="performanceChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            API Performance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-6 mb-3">
                                <div class="metric-value text-primary" id="totalRequests">--</div>
                                <div class="metric-label">Requests/Hour</div>
                            </div>
                            <div class="col-6 mb-3">
                                <div class="metric-value text-info" id="avgResponseTime">--</div>
                                <div class="metric-label">Avg Response (ms)</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-warning" id="errorRate">--</div>
                                <div class="metric-label">Error Rate (%)</div>
                            </div>
                            <div class="col-6">
                                <div class="metric-value text-danger" id="slowRequests">--</div>
                                <div class="metric-label">Slow Requests</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Alerts -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Active Alerts
                            <span class="badge bg-danger ms-2" id="alertCount">0</span>
                        </h5>
                        <button class="btn btn-sm btn-outline-primary" onclick="showAllAlerts()">
                            View All Alerts
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="alertsList">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-check-circle fa-3x mb-3"></i>
                                <p>No active alerts</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="row">
            <div class="col-12">
                <div class="card dashboard-card">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Quick Actions
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-outline-primary w-100" onclick="runHealthCheck()">
                                    <i class="fas fa-heartbeat me-2"></i>
                                    Run Health Check
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-outline-info w-100" onclick="exportReport()">
                                    <i class="fas fa-download me-2"></i>
                                    Export Report
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-outline-warning w-100" onclick="showConfiguration()">
                                    <i class="fas fa-cog me-2"></i>
                                    Configuration
                                </button>
                            </div>
                            <div class="col-md-3 col-6 mb-2">
                                <button class="btn btn-outline-success w-100" onclick="acknowledgeAllAlerts()">
                                    <i class="fas fa-check me-2"></i>
                                    Acknowledge All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Refresh Indicator -->
    <div class="refresh-indicator">
        <div class="spinner-border text-primary loading-spinner" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.min.js"></script>
    <script>
        let performanceChart;
        let refreshInterval;
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();
            loadDashboardData();
            startAutoRefresh();
            
            // Time range change handler
            document.querySelectorAll('input[name="timeRange"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    loadPerformanceData(this.value);
                });
            });
        });
        
        function initializeChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU Usage (%)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Memory Usage (%)',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Response Time (ms)',
                            data: [],
                            borderColor: 'rgb(255, 205, 86)',
                            backgroundColor: 'rgba(255, 205, 86, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            max: 100
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    }
                }
            });
        }
        
        function loadDashboardData() {
            showLoading(true);
            
            fetch('/monitoring/dashboard/')
                .then(response => response.json())
                .then(data => {
                    updateSystemStatus(data.system_status);
                    updateAPIPerformance(data.api_performance);
                    updateAlerts(data.alerts);
                    updateLastUpdated();
                })
                .catch(error => {
                    console.error('Error loading dashboard data:', error);
                    showError('Failed to load dashboard data');
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function updateSystemStatus(status) {
            const statusElement = document.getElementById('overallStatus');
            statusElement.textContent = status.overall_health.toUpperCase();
            statusElement.className = `metric-value status-${status.overall_health}`;
            
            document.getElementById('cpuUsage').textContent = 
                status.cpu_usage ? `${status.cpu_usage.toFixed(1)}%` : '--';
            document.getElementById('memoryUsage').textContent = 
                status.memory_usage ? `${status.memory_usage.toFixed(1)}%` : '--';
            document.getElementById('diskUsage').textContent = 
                status.disk_usage ? `${status.disk_usage.toFixed(1)}%` : '--';
        }
        
        function updateAPIPerformance(performance) {
            document.getElementById('totalRequests').textContent = performance.total_requests_last_hour || 0;
            document.getElementById('avgResponseTime').textContent = 
                performance.average_response_time ? `${performance.average_response_time.toFixed(0)}ms` : '--';
            document.getElementById('errorRate').textContent = 
                performance.error_rate ? `${performance.error_rate.toFixed(1)}%` : '0%';
            document.getElementById('slowRequests').textContent = performance.slow_requests || 0;
        }
        
        function updateAlerts(alerts) {
            const alertCount = document.getElementById('alertCount');
            const alertsList = document.getElementById('alertsList');
            
            alertCount.textContent = alerts.active_count;
            
            if (alerts.active_count === 0) {
                alertsList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x mb-3"></i>
                        <p>No active alerts</p>
                    </div>
                `;
            } else {
                const alertsHtml = alerts.recent_alerts.map(alert => `
                    <div class="alert-item alert-${alert.severity}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${alert.title}</h6>
                                <p class="mb-1 small">${alert.message}</p>
                                <small class="text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${new Date(alert.timestamp).toLocaleString()}
                                </small>
                            </div>
                            <span class="badge bg-${getSeverityColor(alert.severity)}">
                                ${alert.severity.toUpperCase()}
                            </span>
                        </div>
                    </div>
                `).join('');
                alertsList.innerHTML = alertsHtml;
            }
        }
        
        function getSeverityColor(severity) {
            const colors = {
                'info': 'info',
                'warning': 'warning',
                'error': 'danger',
                'critical': 'danger'
            };
            return colors[severity] || 'secondary';
        }
        
        function loadPerformanceData(hours = 1) {
            fetch(`/monitoring/metrics/?hours=${hours}&type=health`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.metrics.health_checks) {
                        updatePerformanceChart(data.data.metrics.health_checks);
                    }
                })
                .catch(error => {
                    console.error('Error loading performance data:', error);
                });
        }
        
        function updatePerformanceChart(healthData) {
            // This would be populated with actual time series data
            // For now, showing placeholder implementation
            const labels = [];
            const cpuData = [];
            const memoryData = [];
            const responseData = [];
            
            // Generate sample data for demonstration
            for (let i = 0; i < 20; i++) {
                labels.push(new Date(Date.now() - (19 - i) * 5 * 60 * 1000).toLocaleTimeString());
                cpuData.push(Math.random() * 100);
                memoryData.push(Math.random() * 100);
                responseData.push(Math.random() * 1000);
            }
            
            performanceChart.data.labels = labels;
            performanceChart.data.datasets[0].data = cpuData;
            performanceChart.data.datasets[1].data = memoryData;
            performanceChart.data.datasets[2].data = responseData;
            performanceChart.update();
        }
        
        function refreshDashboard() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('fa-spin');
            
            loadDashboardData();
            loadPerformanceData(document.querySelector('input[name="timeRange"]:checked').value);
            
            setTimeout(() => {
                icon.classList.remove('fa-spin');
            }, 1000);
        }
        
        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                loadDashboardData();
            }, 30000); // Refresh every 30 seconds
        }
        
        function showLoading(show) {
            const spinner = document.querySelector('.loading-spinner');
            spinner.style.display = show ? 'block' : 'none';
        }
        
        function updateLastUpdated() {
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }
        
        function showError(message) {
            // Simple error display - could be enhanced with toast notifications
            console.error(message);
        }
        
        // Quick action functions
        function runHealthCheck() {
            showLoading(true);
            fetch('/monitoring/health/detailed/')
                .then(response => response.json())
                .then(data => {
                    alert('Health check completed. Status: ' + data.overall_status);
                    loadDashboardData();
                })
                .catch(error => {
                    alert('Health check failed: ' + error.message);
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function exportReport() {
            window.open('/monitoring/reports/export/', '_blank');
        }
        
        function showConfiguration() {
            window.open('/admin/monitoring/monitoringconfiguration/', '_blank');
        }
        
        function acknowledgeAllAlerts() {
            if (confirm('Acknowledge all active alerts?')) {
                fetch('/monitoring/alerts/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({action: 'acknowledge_all'})
                })
                .then(response => response.json())
                .then(data => {
                    alert('All alerts acknowledged');
                    loadDashboardData();
                })
                .catch(error => {
                    alert('Failed to acknowledge alerts: ' + error.message);
                });
            }
        }
        
        function showAllAlerts() {
            window.open('/admin/monitoring/systemalert/', '_blank');
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>