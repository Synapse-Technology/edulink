{% comment %}
API Error Handler Component Template
Provides JavaScript for handling API errors with the error display system
{% endcomment %}

<script>
(function() {
    'use strict';
    
    // API Error Handler Configuration
    const API_ERROR_CONFIG = {
        endpoint: '{{ endpoint_name|default:"" }}',
        retryAction: {{ retry_action|default:"null" }},
        maxRetries: 3,
        retryDelay: 1000
    };
    
    // Enhanced API error handler
    function handleApiError(error, context = {}) {
        const config = { ...API_ERROR_CONFIG, ...context };
        
        // Log error for debugging
        console.error('API Error:', {
            endpoint: config.endpoint,
            error: error,
            context: context
        });
        
        // Use the global error handler
        if (window.ErrorHandler) {
            return window.ErrorHandler.handleApiError(error, {
                displayType: context.displayType || 'toast',
                retryAction: config.retryAction
            });
        }
        
        // Fallback error display
        console.error('ErrorHandler not available, falling back to alert');
        alert('An error occurred: ' + (error.message || 'Unknown error'));
    }
    
    // Fetch wrapper with error handling
    function apiRequest(url, options = {}) {
        const defaultOptions = {
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            }
        };
        
        const mergedOptions = {
            ...defaultOptions,
            ...options,
            headers: {
                ...defaultOptions.headers,
                ...options.headers
            }
        };
        
        return fetch(url, mergedOptions)
            .then(response => {
                if (!response.ok) {
                    const error = new Error(`HTTP ${response.status}: ${response.statusText}`);
                    error.response = response;
                    throw error;
                }
                return response;
            })
            .catch(error => {
                handleApiError(error, {
                    endpoint: url,
                    retryAction: () => apiRequest(url, options)
                });
                throw error;
            });
    }
    
    // CSRF token helper
    function getCsrfToken() {
        const token = document.querySelector('[name=csrfmiddlewaretoken]');
        return token ? token.value : '';
    }
    
    // Form submission with error handling
    function submitFormWithErrorHandling(form, options = {}) {
        const formData = new FormData(form);
        const url = form.action || window.location.href;
        const method = form.method || 'POST';
        
        const submitOptions = {
            method: method.toUpperCase(),
            body: formData,
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        };
        
        return apiRequest(url, submitOptions)
            .then(response => {
                if (response.ok) {
                    if (window.ErrorHandler) {
                        window.ErrorHandler.showSuccess({
                            title: 'Success',
                            message: options.successMessage || 'Form submitted successfully!'
                        });
                    }
                    
                    // Handle redirect or callback
                    if (options.onSuccess) {
                        options.onSuccess(response);
                    } else if (options.redirectUrl) {
                        window.location.href = options.redirectUrl;
                    }
                }
                return response;
            })
            .catch(error => {
                // Form-specific error handling
                if (error.response && error.response.status === 400) {
                    error.response.json().then(data => {
                        if (data.errors) {
                            // Display field-specific errors
                            Object.entries(data.errors).forEach(([fieldName, errors]) => {
                                const field = form.querySelector(`[name="${fieldName}"]`);
                                if (field && window.ErrorHandler) {
                                    window.ErrorHandler.showFieldError(field, errors.join(', '));
                                }
                            });
                        }
                    }).catch(() => {
                        // Fallback to generic error
                        handleApiError(error, { displayType: 'inline', container: form });
                    });
                } else {
                    handleApiError(error, { displayType: 'inline', container: form });
                }
            });
    }
    
    // Auto-attach error handling to forms
    document.addEventListener('DOMContentLoaded', function() {
        // Handle forms with data-error-handling attribute
        const formsWithErrorHandling = document.querySelectorAll('form[data-error-handling]');
        formsWithErrorHandling.forEach(form => {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const options = {
                    successMessage: form.dataset.successMessage,
                    redirectUrl: form.dataset.redirectUrl
                };
                
                submitFormWithErrorHandling(form, options);
            });
        });
        
        // Handle AJAX links with error handling
        const linksWithErrorHandling = document.querySelectorAll('a[data-ajax-error-handling]');
        linksWithErrorHandling.forEach(link => {
            link.addEventListener('click', function(event) {
                event.preventDefault();
                
                const url = link.href;
                const method = link.dataset.method || 'GET';
                
                apiRequest(url, { method })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && window.ErrorHandler) {
                            window.ErrorHandler.showSuccess({
                                title: 'Success',
                                message: data.message || 'Operation completed successfully!'
                            });
                        }
                        
                        // Handle callback
                        if (link.dataset.onSuccess) {
                            const callback = new Function('data', link.dataset.onSuccess);
                            callback(data);
                        }
                    })
                    .catch(error => {
                        handleApiError(error);
                    });
            });
        });
    });
    
    // Export functions for global use
    window.apiRequest = apiRequest;
    window.submitFormWithErrorHandling = submitFormWithErrorHandling;
    window.handleApiError = handleApiError;
    
})();
</script>