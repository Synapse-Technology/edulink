<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pantha Group Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="flex bg-gray-100 h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside class="w-64 bg-teal-800 text-white p-4 border-r overflow-y-auto flex flex-col h-full">
    <div class="text-2xl font-bold mb-10">Pantha Group</div>
    <nav class="space-y-2">
      <button onclick="showSection('dashboard')" class="block text-white hover:text-blue-600 w-full text-left">Dashboard</button>
      <button onclick="showSection('post')" class="block text-white hover:text-blue-600 w-full text-left">Post Opportunities</button>
      <button onclick="showSection('applications')" class="block text-white hover:text-blue-600 w-full text-left">Applications</button>
      <button onclick="showSection('interns')" class="block text-white hover:text-blue-600 w-full text-left">Active Interns</button>
      <button onclick="showSection('interviews')" class="block text-white hover:text-blue-600 w-full text-left">Scheduled Interviews</button>
      <button onclick="showSection('feedback')" class="block text-white hover:text-blue-600 w-full text-left">Feedback</button>
      <a href="opportunities.html" class="block text-white hover:text-blue-600 w-full text-left">View Opportunities</a>
      <a href="#" class="block text-white hover:text-blue-600">Log Out</a>
    </nav>
    <div class="text-sm text-white mt-auto">
      <a href="#" class="block">Settings</a>
      <a href="#" class="block">Help Center</a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 p-8 overflow-y-auto">
    <!-- Dashboard Section -->
    <section id="dashboard-section">
      <h1 class="text-3xl font-bold mb-6 text-teal-800">Dashboard</h1>
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="bg-gradient-to-br from-green-400 to-blue-500 p-6 shadow-lg rounded-xl flex flex-col items-start justify-center text-white border-2 border-teal-700" id="new-applications-box">
          <h2 class="text-lg font-semibold mb-2 flex items-center"><svg class="w-6 h-6 mr-2 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 11c0-1.104-.896-2-2-2s-2 .896-2 2 .896 2 2 2 2-.896 2-2zm0 0c0-1.104.896-2 2-2s2 .896 2 2-.896 2-2 2-2-.896-2-2zm-6 8v-1a4 4 0 014-4h4a4 4 0 014 4v1"/></svg>New Applications</h2>
          <p class="text-4xl font-extrabold mb-1" id="new-applications-count">...</p>
          <span class="text-sm opacity-80">Total applicants across all opportunities</span>
        </div>
        <div class="bg-gradient-to-br from-teal-500 to-blue-500 p-6 shadow-lg rounded-xl flex flex-col items-start justify-center text-white border-2 border-yellow-600" id="upcoming-interviews-box">
          <h2 class="text-lg font-semibold mb-2 flex items-center"><svg class="w-6 h-6 mr-2 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2v-7a2 2 0 00-2-2H5a2 2 0 00-2 2v7a2 2 0 002 2z"/></svg>Upcoming Interviews</h2>
          <p class="text-4xl font-extrabold mb-1" id="upcoming-interviews-count">...</p>
          <span class="text-sm opacity-80">Total scheduled interviews</span>
        </div>
        <div class="bg-gradient-to-br from-green-400 to-blue-500 p-6 shadow-lg rounded-xl flex flex-col items-start justify-center text-white border-2 border-green-600" id="available-internships-box">
          <h2 class="text-lg font-semibold mb-2 flex items-center"><svg class="w-6 h-6 mr-2 text-white" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 01-8 0M12 14v7m-7-7a7 7 0 0114 0v7H5v-7z"/></svg>Available Internships</h2>
          <p class="text-4xl font-extrabold mb-1" id="available-internships-count">...</p>
          <span class="text-sm opacity-80">Total posted opportunities</span>
        </div>
      </div>
      <!-- Applications Table Preview -->
      <div class="bg-white p-4 shadow rounded mb-6">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Applied opportunities</h3>
          <div>
            <input type="text" id="search-applications" placeholder="Search..." class="border px-2 py-1 text-sm rounded">
            <button class="ml-2 px-2 py-1 text-sm bg-gray-200 rounded">Filter</button>
          </div>
        </div>
        <table class="w-full text-sm text-left">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2">Name of opportunities</th>
              <th>Number of Applicants</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="applications-table-preview">
            <!-- Populated by JS -->
          </tbody>
        </table>
        <div class="flex justify-end mt-4">
          <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="showSection('applications')">
            View All
          </button>
        </div>
      </div>
      <!-- Active Interns Preview -->
      <div class="bg-white p-4 shadow rounded">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-lg font-semibold">Active Interns</h3>
          <div>
            <input type="text" id="search-interns" placeholder="Search..." class="border px-2 py-1 text-sm rounded">
            <button class="ml-2 px-2 py-1 text-sm bg-gray-200 rounded">Filter</button>
          </div>
        </div>
        <table class="w-full text-sm text-left">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-2">Name</th>
              <th>Role</th>
              <th>From</th>
              <th>To</th>
              <th>Progress</th>
            </tr>
          </thead>
          <tbody id="interns-table-preview">
            <!-- Populated by JS -->
          </tbody>
        </table>
        <div class="flex justify-end mt-4">
          <button class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="showSection('interns')">
            View All
          </button>
        </div>
      </div>
    </section>

    <!-- Post Opportunities Section -->
    <section id="post-section" style="display:none">
      <h2 class="text-2xl font-bold mb-4">Post Internship Opportunity</h2>
      <button class="btn btn-primary bg-teal-700 text-white px-4 py-2 rounded hover:bg-teal-900 mb-4" onclick="showInternshipModal()">
        <i class="fas fa-plus"></i> Post Internship
      </button>
      <div class="bg-white p-4 shadow rounded">
        <h3 class="text-lg font-semibold mb-3">Manage Posted Internships</h3>
        <div class="internships-table-container" id="manageInternshipsTableContainer"></div>
      </div>
      <!-- Internship Modal -->
      <div id="internshipModal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-lg p-8 w-full max-w-xl relative" style="max-height:90vh; overflow-y:auto;">
          <span class="close absolute top-4 right-6 text-2xl cursor-pointer" onclick="closeInternshipModal()">&times;</span>
          <h2 id="internshipModalTitle" class="text-xl font-bold mb-4">Post Internship</h2>
          <form id="internshipForm" onsubmit="return false;">
            <input type="hidden" name="internshipId">
            <div class="form-group mb-3">
              <label class="block mb-1">Title</label>
              <input type="text" name="title" required placeholder="e.g. Software Engineering Intern" class="w-full border rounded px-3 py-2">
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Description</label>
              <textarea name="description" required placeholder="Describe the internship role and responsibilities" rows="3" class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Requirements</label>
              <textarea name="requirements" required placeholder="List requirements, e.g. skills, year of study" rows="2" class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Location</label>
              <textarea name="location" required placeholder="Location eg, Juja" rows="2" class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Application Deadline</label>
              <input type="date" name="deadline" required class="w-full border rounded px-3 py-2">
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Status</label>
              <select name="status" required class="w-full border rounded px-3 py-2">
                <option value="active">Active</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Number of Applicants</label>
              <input type="number" name="applicants" placeholder="number eg, 20" class="w-full border rounded px-3 py-2" min="0">
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Target Audience</label>
              <select name="audience" class="w-full border rounded px-3 py-2" id="audienceSelect">
                <option value="everyone">Everyone</option>
              </select>
            </div>
            <div class="form-group mb-3">
              <label class="block mb-1">Duration (months)</label>
              <input type="number" name="duration" min="1" required placeholder="e.g. 3" class="w-full border rounded px-3 py-2">
            </div>
            <div style="text-align:right;">
              <button type="button" class="btn btn-primary bg-teal-700 text-white px-4 py-2 rounded hover:bg-teal-900" id="saveInternshipBtn">
                <i class="fas fa-check"></i> Save Internship
              </button>
            </div>
          </form>
        </div>
      </div>
    </section>

    <!-- Applications Section -->
    <section id="applications-section" style="display:none">
      <h2 class="text-2xl font-bold mb-4">Applications</h2>
      <div class="bg-white shadow rounded-lg p-6">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-teal-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">Opportunity</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">Number of Applicants</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">Audience</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">Applicants</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="applicationsTableBody">
            <!-- Dynamic rows will be inserted here -->
          </tbody>
        </table>
      </div>
      <!-- Applicants Modal -->
      <div id="applicantsModal" class="modal fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative" style="max-height:90vh; overflow-y:auto;">
          <span class="close absolute top-4 right-6 text-2xl cursor-pointer" onclick="closeApplicantsModal()">&times;</span>
          <h2 class="text-xl font-bold mb-4">Applicants</h2>
          <ul id="applicantsList" class="list-disc pl-6"></ul>
        </div>
      </div>
    </section>

    <!-- Interns Section -->
    <section id="interns-section" style="display:none">
      <h2 class="text-2xl font-bold mb-4">Active Interns</h2>
      <div class="bg-white shadow rounded-lg p-6">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-teal-100">
            <tr>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">Name</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">Role</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">From</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">To</th>
              <th class="px-6 py-3 text-left text-xs font-medium text-teal-800 uppercase">Progress</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200" id="internsTableBody">
            <!-- Dynamic rows will be inserted here -->
          </tbody>
        </table>
      </div>
    </section>

    <!-- Interviews Section -->
    <section id="interviews-section" style="display:none">
      <h2 class="text-2xl font-bold mb-4">Scheduled Interviews</h2>
      <div class="bg-white p-4 shadow rounded" id="scheduledInterviewsTableContainer"></div>
    </section>

    <!-- Feedback Section -->
    <section id="feedback-section" style="display:none">
      <h2 class="text-2xl font-bold mb-4">Feedback</h2>
      <div class="bg-white p-4 shadow rounded">(Feedback content here)</div>
    </section>
  </main>

  <script>
    // Navigation logic
    function showSection(section) {
      const sections = ['dashboard', 'post', 'applications', 'interns', 'interviews', 'feedback'];
      sections.forEach(s => {
        document.getElementById(s+'-section').style.display = (s === section) ? '' : 'none';
      });
      if(section === 'applications') renderApplicationsTable();
      if(section === 'interns') renderInternsTable();
      if(section === 'post') renderInternshipsTable();
      if(section === 'dashboard') {
        renderApplicationsPreview();
        renderActiveInternsPreview();
        renderAvailableInternshipsCount();
        renderUpcomingInterviewsCount();
        renderNewApplicationsCount();
      }
      if(section === 'interviews') renderScheduledInterviewsTable();
    }
    // Show dashboard by default and render previews
    renderApplicationsPreview();
    renderActiveInternsPreview();
    renderAvailableInternshipsCount();
    renderUpcomingInterviewsCount();
    renderNewApplicationsCount();
    showSection('dashboard');

    // Applications Section Logic
    function renderApplicationsTable() {
      const internships = JSON.parse(localStorage.getItem('internships') || '[]');
      const applications = JSON.parse(localStorage.getItem('applications') || '{}');
      const tbody = document.getElementById('applicationsTableBody');
      if (!internships.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No opportunities posted yet.</td></tr>';
        return;
      }
      let html = '';
      internships.forEach((intern, idx) => {
        const applicantList = applications[intern.title] || [];
        html += `<tr id="opportunity-row-${idx}">
          <td class="px-6 py-4 whitespace-nowrap">${intern.title}</td>
          <td class="px-6 py-4 whitespace-nowrap">${(applications[intern.title] || []).length}</td>
          <td class="px-6 py-4 whitespace-nowrap">${intern.audience || ''}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <button class="text-teal-700 hover:underline text-sm" onclick="toggleApplicantsList(${idx}, '${intern.title.replace(/'/g, "\\'")}')">View</button>
          </td>
        </tr>`;
        // Inline applicants row with details and actions
        html += `<tr id="applicants-row-${idx}" style="display:none;"><td colspan="5"><div class="bg-gray-50 p-4 rounded">
          <strong>Applicants:</strong>
          <div class="overflow-x-auto mt-2">
            <table class="min-w-full text-xs">
              <thead><tr><th class="pr-4">Name</th><th class="pr-4">Date</th><th class="pr-4">Profile</th><th class="pr-4">Interview</th><th>Decline</th><th>Recruit</th></tr></thead>
              <tbody>`;
        if (applicantList.length) {
          applicantList.forEach((app, i) => {
            html += `<tr>
              <td class="pr-4 py-1">${app.name || app}</td>
              <td class="pr-4 py-1">${app.date || ''}</td>
              <td class="pr-4 py-1"><button class="bg-blue-500 text-white px-2 py-1 rounded" onclick="alert('Profile for ${app.name || app}')">View Profile</button></td>
              <td class="pr-4 py-1"><button class="bg-green-600 text-white px-2 py-1 rounded" onclick="openScheduleInterviewModal('${intern.title.replace(/'/g, "\\'")}', ${i})">Schedule Interview</button></td>
              <td class="py-1"><button class="bg-red-500 text-white px-2 py-1 rounded" onclick="declineApplicant('${intern.title.replace(/'/g, "\\'")}', ${i})">Decline</button></td>
              <td class="py-1"><button class="bg-teal-700 text-white px-2 py-1 rounded" onclick="recruitApplicant('${intern.title.replace(/'/g, "\\'")}', ${i})">Recruit</button></td>
            </tr>`;
          });
        } else {
          html += `<tr><td colspan="6" class='text-gray-500 py-2'>No applicants yet.</td></tr>`;
        }
        html += `</tbody></table></div></div></td></tr>`;
      });
      tbody.innerHTML = html;
    }
    function toggleApplicantsList(idx, title) {
      // Hide all other applicant rows
      const internships = JSON.parse(localStorage.getItem('internships') || '[]');
      internships.forEach((_, i) => {
        if (i !== idx) {
          const row = document.getElementById('applicants-row-' + i);
          if (row) row.style.display = 'none';
        }
      });
      // Toggle this one
      const row = document.getElementById('applicants-row-' + idx);
      if (row) {
        row.style.display = (row.style.display === 'none' || row.style.display === '') ? '' : 'none';
      }
    }

    // Decline applicant function
    function declineApplicant(title, idx) {
      let applications = JSON.parse(localStorage.getItem('applications') || '{}');
      if (!applications[title]) return;
      if (!confirm('Are you sure you want to decline this applicant?')) return;
      applications[title].splice(idx, 1);
      localStorage.setItem('applications', JSON.stringify(applications));
      renderApplicationsTable();
    }

    // Add recruitApplicant function
    function recruitApplicant(title, idx) {
      let applications = JSON.parse(localStorage.getItem('applications') || '{}');
      let interns = JSON.parse(localStorage.getItem('interns') || '[]');
      let internships = JSON.parse(localStorage.getItem('internships') || '[]');
      if (!applications[title]) return;
      const applicant = applications[title][idx];
      if (!applicant) return;
      // Find internship to get duration
      const internship = internships.find(i => i.title === title);
      let fromDate = new Date().toISOString().split('T')[0];
      let toDate = '';
      if (internship && internship.duration) {
        let from = new Date();
        from.setMonth(from.getMonth() + parseInt(internship.duration));
        toDate = from.toISOString().split('T')[0];
      }
      interns.push({
        name: applicant.name || applicant,
        role: title,
        from: fromDate,
        to: toDate,
        progress: 0
      });
      applications[title].splice(idx, 1);
      localStorage.setItem('interns', JSON.stringify(interns));
      localStorage.setItem('applications', JSON.stringify(applications));
      renderApplicationsTable();
      renderInternsTable && renderInternsTable();
      renderActiveInternsPreview && renderActiveInternsPreview();
    }

    // Interns Section Logic
    function renderInternsTable() {
      const interns = JSON.parse(localStorage.getItem('interns') || '[]');
      const tbody = document.getElementById('internsTableBody');
      if (!tbody) return;
      if (!interns.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-500 py-4">No active interns found.</td></tr>';
        return;
      }
      let html = '';
      interns.forEach((intern, idx) => {
        html += `<tr>
          <td class="px-6 py-4 whitespace-nowrap">${intern.name}</td>
          <td class="px-6 py-4 whitespace-nowrap">${intern.role}</td>
          <td class="px-6 py-4 whitespace-nowrap">${intern.from}</td>
          <td class="px-6 py-4 whitespace-nowrap">${intern.to}</td>
          <td class="px-6 py-4 whitespace-nowrap">
            <div class='w-full bg-gray-200 rounded-full h-2.5'>
              <div class='bg-teal-600 h-2.5 rounded-full' style='width: ${intern.progress || 0}%;'></div>
            </div>
            <span class='text-xs text-gray-600 ml-2'>${intern.progress || 0}%</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <button class="bg-blue-500 text-white px-2 py-1 rounded mr-2" onclick="viewLogbook(${idx})">View</button>
            <button class="bg-red-500 text-white px-2 py-1 rounded" onclick="removeIntern(${idx})">Remove</button>
          </td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }

    // Handler for viewing logbook
    function viewLogbook(idx) {
      const interns = JSON.parse(localStorage.getItem('interns') || '[]');
      const intern = interns[idx];
      if (!intern) return alert('Intern not found.');
      // Redirect to logbooks.html with intern name as query parameter
      window.location.href = `logbooks.html?intern=${encodeURIComponent(intern.name)}`;
    }

    // Save logbook entry for intern
    function saveLogbookEntry(idx) {
      const interns = JSON.parse(localStorage.getItem('interns') || '[]');
      const intern = interns[idx];
      if (!intern) return alert('Intern not found.');
      const entry = document.getElementById('logbookEntry').value.trim();
      if (!entry) return alert('Please enter a logbook entry.');
      intern.logbook = (intern.logbook ? intern.logbook + '<br>' : '') + entry;
      interns[idx] = intern;
      localStorage.setItem('interns', JSON.stringify(interns));
      document.getElementById('logbookContent').innerHTML = intern.logbook;
      document.getElementById('logbookEntry').value = '';
    }

    // Handler for removing intern
    function removeIntern(idx) {
      let interns = JSON.parse(localStorage.getItem('interns') || '[]');
      if (!interns[idx]) return alert('Intern not found.');
      if (!confirm('Are you sure you want to remove this intern?')) return;
      interns.splice(idx, 1);
      localStorage.setItem('interns', JSON.stringify(interns));
      renderInternsTable();
      renderActiveInternsPreview && renderActiveInternsPreview();
    }

    // --- Post Opportunities Section Logic ---
    // Populate audience dropdown from localStorage
    function populateAudienceDropdown() {
      const select = document.getElementById('audienceSelect');
      if (!select) return;
      // Remove all except 'Everyone'
      for (let i = select.options.length - 1; i > 0; i--) select.remove(i);
      const institutions = JSON.parse(localStorage.getItem('institutions') || '[]');
      institutions.forEach(inst => {
        const opt = document.createElement('option');
        opt.value = inst;
        opt.textContent = inst;
        select.appendChild(opt);
      });
    }

    function showInternshipModal() {
      document.getElementById('internshipModal').classList.remove('hidden');
      document.getElementById('internshipForm').reset();
      document.querySelector('input[name="internshipId"]').value = '';
      document.getElementById('internshipModalTitle').innerText = 'Post Internship';
      populateAudienceDropdown();
    }

    function closeInternshipModal() {
      document.getElementById('internshipModal').classList.add('hidden');
    }

    function renderInternshipsTable() {
      let internships = JSON.parse(localStorage.getItem('internships') || '[]');
      const container = document.getElementById('manageInternshipsTableContainer');
      if (!internships.length) {
        container.innerHTML = '<div class="text-gray-500">No internships posted yet.</div>';
        return;
      }
      let html = '<table class="min-w-full text-sm border"><thead><tr><th class="border px-2 py-1">Title</th><th class="border px-2 py-1">Deadline</th><th class="border px-2 py-1">Status</th><th class="border px-2 py-1">Audience</th><th class="border px-2 py-1">Actions</th></tr></thead><tbody>';
      internships.forEach((intern, idx) => {
        html += `<tr>
          <td class="border px-2 py-1">${intern.title}</td>
          <td class="border px-2 py-1">${intern.deadline}</td>
          <td class="border px-2 py-1">${intern.status}</td>
          <td class="border px-2 py-1">${intern.audience || ''}</td>
          <td class="border px-2 py-1">
            <button class='text-blue-600 hover:underline mr-2' onclick='editInternship(${idx})'>Edit</button>
            <button class='text-red-600 hover:underline' onclick='deleteInternship(${idx})'>Delete</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function editInternship(idx) {
      let internships = JSON.parse(localStorage.getItem('internships') || '[]');
      const intern = internships[idx];
      const form = document.getElementById('internshipForm');
      document.getElementById('internshipModal').classList.remove('hidden');
      document.getElementById('internshipModalTitle').innerText = 'Edit Internship';
      populateAudienceDropdown();
      form.internshipId.value = idx;
      form.title.value = intern.title;
      form.description.value = intern.description;
      form.requirements.value = intern.requirements;
      form.location.value = intern.location;
      form.deadline.value = intern.deadline;
      form.status.value = intern.status;
      form.applicants.value = intern.applicants === 'undefined' ? '' : intern.applicants;
      form.audience.value = intern.audience || 'everyone';
      form.duration.value = intern.duration || '';
    }

    function deleteInternship(idx) {
      let internships = JSON.parse(localStorage.getItem('internships') || '[]');
      if (confirm('Are you sure you want to delete this opportunity?')) {
        internships.splice(idx, 1);
        localStorage.setItem('internships', JSON.stringify(internships));
        renderInternshipsTable();
        renderApplicationsTable && renderApplicationsTable();
      }
    }

    document.getElementById('saveInternshipBtn').onclick = function() {
      let internships = JSON.parse(localStorage.getItem('internships') || '[]');
      const form = document.getElementById('internshipForm');
      const idx = form.internshipId.value;
      let applicants = form.applicants.value;
      if (applicants === '' || applicants === null) applicants = 'undefined';
      // Validate required fields
      const requiredFields = ['title', 'description', 'requirements', 'location', 'deadline', 'status', 'duration'];
      let missing = [];
      requiredFields.forEach(field => {
        if (!form[field].value || form[field].value.trim() === '') {
          missing.push(field);
        }
      });
      if (missing.length > 0) {
        alert('Please fill all required fields: ' + missing.join(', '));
        return;
      }
      const data = {
        title: form.title.value,
        description: form.description.value,
        requirements: form.requirements.value,
        location: form.location.value,
        deadline: form.deadline.value,
        status: form.status.value,
        applicants: applicants,
        audience: form.audience.value,
        duration: form.duration.value
      };
      if (idx !== '') {
        internships[idx] = data;
      } else {
        internships.push(data);
      }
      localStorage.setItem('internships', JSON.stringify(internships));
      renderInternshipsTable();
      renderApplicationsTable && renderApplicationsTable();
      closeInternshipModal();
    };

    function openScheduleInterviewModal(title, applicantIdx) {
      const applications = JSON.parse(localStorage.getItem('applications') || '{}');
      const applicant = (applications[title] || [])[applicantIdx];
      if (!applicant) return;
      const modal = document.createElement('div');
      modal.id = 'scheduleInterviewModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative" style="max-height:90vh; overflow-y:auto;">
          <span class="close absolute top-4 right-6 text-2xl cursor-pointer" onclick="document.body.removeChild(document.getElementById('scheduleInterviewModal'))">&times;</span>
          <h2 class="text-xl font-bold mb-4">Schedule Interview for ${applicant.name || applicant}</h2>
          <form id="scheduleInterviewForm" onsubmit="return false;">
            <div class="mb-3">
              <label class="block mb-1">Interview Time</label>
              <input type="datetime-local" name="interviewTime" required class="w-full border rounded px-3 py-2">
            </div>
            <div class="mb-3">
              <label class="block mb-1">Location</label>
              <input type="text" name="location" required placeholder="e.g. Boardroom 1" class="w-full border rounded px-3 py-2">
            </div>
            <div class="mb-3">
              <label class="block mb-1">Note</label>
              <textarea name="note" placeholder="What to know..." class="w-full border rounded px-3 py-2"></textarea>
            </div>
            <div class="flex justify-between">
              <button type="button" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-700" onclick="setInterviewReminderFromModal()">Set Reminder</button>
              <button type="button" class="bg-teal-700 text-white px-4 py-2 rounded hover:bg-teal-900" onclick="saveScheduledInterviewAndShow('${title.replace(/'/g, "\\'")}', ${applicantIdx})">Schedule</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveScheduledInterviewAndShow(title, applicantIdx) {
      const form = document.getElementById('scheduleInterviewForm');
      const time = form.interviewTime.value;
      const location = form.location.value;
      const note = form.note.value;
      if (!time || !location) return alert('Please fill all required fields.');
      // Get applicant info
      const applications = JSON.parse(localStorage.getItem('applications') || '{}');
      const applicant = (applications[title] || [])[applicantIdx];
      if (!applicant) return;
      // Save to scheduledInterviews in localStorage
      let scheduled = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');
      scheduled.push({
        name: applicant.name || applicant,
        time,
        location,
        note
      });
      localStorage.setItem('scheduledInterviews', JSON.stringify(scheduled));
      // Remove modal
      document.body.removeChild(document.getElementById('scheduleInterviewModal'));
      alert('Interview scheduled!');
      renderScheduledInterviewsTable && renderScheduledInterviewsTable(); // Only update if on interviews page
    }

    // --- Dashboard Preview Logic ---
    function renderApplicationsPreview() {
      const internships = JSON.parse(localStorage.getItem('internships') || '[]');
      const applications = JSON.parse(localStorage.getItem('applications') || '{}');
      const tbody = document.getElementById('applications-table-preview');
      if (!tbody) return;
      if (!internships.length) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-4">No opportunities posted yet.</td></tr>';
        return;
      }
      // Get the 3 most recent internships (latest added at the end)
      const recentInternships = internships.slice(-3).reverse();
      let html = '';
      recentInternships.forEach(intern => {
        html += `<tr>
          <td class="p-2">${intern.title}</td>
          <td>${(applications[intern.title] || []).length}</td>
          <td><button class="text-teal-700 hover:underline text-sm" onclick="showSection('applications')">Details</button></td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }

    function renderActiveInternsPreview() {
      const interns = JSON.parse(localStorage.getItem('interns') || '[]');
      const tbody = document.getElementById('interns-table-preview');
      if (!tbody) return;
      if (!interns.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-4">No active interns found.</td></tr>';
        return;
      }
      // Get the 3 most recent interns (latest added at the end)
      const recentInterns = interns.slice(-3).reverse();
      let html = '';
      recentInterns.forEach(intern => {
        html += `<tr>
          <td class="p-2">${intern.name}</td>
          <td>${intern.role}</td>
          <td>${intern.from}</td>
          <td>${intern.to}</td>
          <td>
            <div class='w-full bg-gray-200 rounded-full h-2.5'>
              <div class='bg-teal-600 h-2.5 rounded-full' style='width: ${intern.progress || 0}%;'></div>
            </div>
            <span class='text-xs text-gray-600 ml-2'>${intern.progress || 0}%</span>
          </td>
        </tr>`;
      });
      tbody.innerHTML = html;
    }

    // --- Dashboard Available Internships Count ---
    function renderAvailableInternshipsCount() {
      const internships = JSON.parse(localStorage.getItem('internships') || '[]');
      const countElem = document.getElementById('available-internships-count');
      if (countElem) {
        countElem.textContent = internships.length;
      }
    }

    // --- Dashboard Upcoming Interviews Count ---
    function renderUpcomingInterviewsCount() {
      const scheduled = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');
      const countElem = document.getElementById('upcoming-interviews-count');
      if (countElem) {
        countElem.textContent = scheduled.length;
      }
    }

    // --- Dashboard New Applications Count ---
    function renderNewApplicationsCount() {
      const applications = JSON.parse(localStorage.getItem('applications') || '{}');
      let total = 0;
      Object.values(applications).forEach(appList => {
        if (Array.isArray(appList)) total += appList.length;
      });
      const countElem = document.getElementById('new-applications-count');
      if (countElem) {
        countElem.textContent = total;
      }
    }

    // --- Scheduled Interviews Section Logic ---
    function renderScheduledInterviewsTable() {
      const scheduled = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');
      const section = document.getElementById('interviews-section');
      if (!section) return;
      let container = document.getElementById('scheduledInterviewsTableContainer');
      if (!container) {
        container = document.createElement('div');
        container.id = 'scheduledInterviewsTableContainer';
        section.appendChild(container);
      }
      if (!scheduled.length) {
        container.innerHTML = '<div class="text-gray-500">No interviews scheduled yet.</div>';
        return;
      }
      let html = '<table class="min-w-full text-sm border"><thead><tr><th class="border px-2 py-1">Name</th><th class="border px-2 py-1">Time</th><th class="border px-2 py-1">Location</th><th class="border px-2 py-1">Action</th></tr></thead><tbody>';
      scheduled.forEach((interview, idx) => {
        html += `<tr>
          <td class="border px-2 py-1">${interview.name}</td>
          <td class="border px-2 py-1">${interview.time}</td>
          <td class="border px-2 py-1">${interview.location}</td>
          <td class="border px-2 py-1">
            <button class="bg-fuchsia-300 text-white px-4 py-1 rounded hover:bg-fuchsia-400" onclick="openRescheduleInterviewModal(${idx})">Reschedule</button>
          </td>
        </tr>`;
      });
      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Modal for rescheduling interview
    function openRescheduleInterviewModal(idx) {
      const scheduled = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');
      const interview = scheduled[idx];
      if (!interview) return;
      let modal = document.getElementById('rescheduleInterviewModal');
      if (modal) document.body.removeChild(modal);
      modal = document.createElement('div');
      modal.id = 'rescheduleInterviewModal';
      modal.className = 'fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-lg shadow-lg p-8 w-full max-w-md relative" style="max-height:90vh; overflow-y:auto;">
          <span class="close absolute top-4 right-6 text-2xl cursor-pointer" onclick="document.body.removeChild(document.getElementById('rescheduleInterviewModal'))">&times;</span>
          <h2 class="text-xl font-bold mb-4">Reschedule Interview for ${interview.name}</h2>
          <form id="rescheduleInterviewForm" onsubmit="return false;">
            <div class="mb-3">
              <label class="block mb-1">Interview Time</label>
              <input type="datetime-local" name="interviewTime" required class="w-full border rounded px-3 py-2" value="${interview.time}">
            </div>
            <div class="mb-3">
              <label class="block mb-1">Location</label>
              <input type="text" name="location" required placeholder="e.g. Boardroom 1" class="w-full border rounded px-3 py-2" value="${interview.location}">
            </div>
            <div class="flex justify-between mt-4">
              <button type="button" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-700" onclick="deleteScheduledInterview(${idx})">Delete</button>
              <button type="button" class="bg-teal-700 text-white px-4 py-2 rounded hover:bg-teal-900" onclick="saveRescheduledInterview(${idx})">Save Changes</button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function saveRescheduledInterview(idx) {
      const scheduled = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');
      const form = document.getElementById('rescheduleInterviewForm');
      if (!form) return;
      const time = form.interviewTime.value;
      const location = form.location.value;
      if (!time || !location) return alert('Please fill all required fields.');
      scheduled[idx].time = time;
      scheduled[idx].location = location;
      localStorage.setItem('scheduledInterviews', JSON.stringify(scheduled));
      document.body.removeChild(document.getElementById('rescheduleInterviewModal'));
      renderScheduledInterviewsTable();
    }

    function deleteScheduledInterview(idx) {
      let scheduled = JSON.parse(localStorage.getItem('scheduledInterviews') || '[]');
      if (!confirm('Are you sure you want to delete this interview?')) return;
      scheduled.splice(idx, 1);
      localStorage.setItem('scheduledInterviews', JSON.stringify(scheduled));
      document.body.removeChild(document.getElementById('rescheduleInterviewModal'));
      renderScheduledInterviewsTable();
    }
  </script>
</body>
</html>
